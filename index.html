<!DOCTYPE html>
<html lang="es-CR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Agenda Digital DRTE - Sistema Integral de Gesti√≥n Profesional">
    <meta name="theme-color" content="#1a1a2e">
    <title>Agenda Digital DRTE | Sistema Profesional MEP</title>
    
    <!-- ENLACES EXTERNOS DRTE -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/docx@7.7.0/build/index.js"></script>
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    
    <style>
        /* ===== ESTILOS PROFESIONALES COMPLETOS ===== */
        :root {
            --color-primary: #1a1a2e; --color-secondary: #16213e; --color-accent: #0f3460;
            --color-success: #00b894; --color-warning: #fdcb6e; --color-danger: #d63031;
            --color-info: #0984e3; --color-light: #f8f9fa; --color-dark: #2d3436;
            --border-radius: 12px; --box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            --transition: all 0.3s ease; --glass-bg: rgba(255,255,255,0.05);
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-secondary) 100%);
            color: var(--color-light);
            min-height: 100vh;
            line-height: 1.6;
        }
        
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }

        /* ===== HEADER CORPORATIVO ===== */
        .header {
            background: rgba(255,255,255,0.08); backdrop-filter: blur(20px); border-radius: var(--border-radius);
            padding: 20px 30px; margin-bottom: 30px; border: 1px solid rgba(255,255,255,0.1);
            display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;
            box-shadow: var(--box-shadow);
        }
        
        .brand {
            display: flex; align-items: center; gap: 20px;
        }
        
        .logo {
            width: 60px; height: 60px; background: linear-gradient(135deg, #00c6ff 0%, #0072ff 100%);
            border-radius: var(--border-radius); display: flex; align-items: center; justify-content: center;
            font-size: 28px; color: white; box-shadow: 0 5px 15px rgba(0,198,255,0.4);
        }
        
        .brand-info h1 { font-size: 1.8rem; font-weight: 700; margin-bottom: 5px; }
        .brand-info p { color: rgba(255,255,255,0.7); font-size: 0.9rem; }
        
        /* ===== PANEL DE ENLACES EXTERNOS DRTE ===== */
        .external-links-panel {
            background: rgba(0,0,0,0.3);
            padding: 15px 30px;
            border-radius: var(--border-radius);
            margin-bottom: 30px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .links-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .external-link {
            color: rgba(255,255,255,0.9);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 0.9rem;
            padding: 12px 20px;
            border-radius: var(--border-radius);
            transition: var(--transition);
            background: rgba(255,255,255,0.07);
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .external-link:hover {
            background: rgba(255,255,255,0.15);
            color: white;
            transform: translateY(-3px);
            border-color: #00c6ff;
        }
        
        .external-link i {
            font-size: 1.1rem;
            width: 20px;
            text-align: center;
        }
        
        /* ===== DASHBOARD PRINCIPAL ===== */
        .dashboard-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 25px; margin-bottom: 30px;
        }
        
        .card {
            background: rgba(255,255,255,0.08); backdrop-filter: blur(20px); border-radius: var(--border-radius);
            padding: 25px; border: 1px solid rgba(255,255,255,0.1); box-shadow: var(--box-shadow);
        }
        
        .card-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;
        }
        
        .card-header h2 { font-size: 1.3rem; font-weight: 600; display: flex; align-items: center; gap: 10px; }
        
        /* ===== SISTEMA DE PESTA√ëAS ===== */
        .tabs-container {
            margin-bottom: 30px;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .tab-btn {
            padding: 12px 25px;
            background: rgba(255,255,255,0.07);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: var(--border-radius);
            color: white;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 500;
        }
        
        .tab-btn.active {
            background: linear-gradient(135deg, #00c6ff 0%, #0072ff 100%);
            border-color: transparent;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* ===== BIT√ÅCORA DIARIA ===== */
        .journal-editor {
            min-height: 400px;
            background: rgba(255,255,255,0.05);
            border-radius: var(--border-radius);
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .journal-toolbar {
            display: flex;
            gap: 10px;
            padding: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            flex-wrap: wrap;
        }
        
        .toolbar-btn {
            padding: 8px 15px;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
        }
        
        .journal-date-selector {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        /* ===== SISTEMA DE ARCHIVOS POR FECHA ===== */
        .file-date-navigation {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .date-breadcrumb {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
            color: rgba(255,255,255,0.7);
        }
        
        .file-structure {
            background: rgba(255,255,255,0.05);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .folder {
            margin-bottom: 15px;
            cursor: pointer;
        }
        
        .folder-header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: rgba(255,255,255,0.07);
            border-radius: 8px;
        }
        
        .folder-content {
            padding-left: 30px;
            margin-top: 10px;
            display: none;
        }
        
        .folder-content.expanded {
            display: block;
        }
        
        .file-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            margin: 5px 0;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
        }
        
        /* ===== BOTONES PROFESIONALES ===== */
        .btn {
            padding: 12px 24px; border: none; border-radius: var(--border-radius); font-weight: 600;
            cursor: pointer; transition: var(--transition); display: inline-flex; align-items: center; gap: 10px;
            font-size: 0.95rem; text-decoration: none; user-select: none;
        }
        
        .btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.2); }
        
        .btn-primary { background: linear-gradient(135deg, #00c6ff 0%, #0072ff 100%); color: white; }
        .btn-secondary { background: var(--glass-bg); color: white; border: 1px solid rgba(255,255,255,0.2); }
        .btn-success { background: var(--color-success); color: white; }
        .btn-danger { background: var(--color-danger); color: white; }
        .btn-email { background: linear-gradient(135deg, #0078D4 0%, #005a9e 100%); color: white; }
        .btn-print { background: linear-gradient(135deg, #666666 0%, #333333 100%); color: white; }
        
        /* ===== FORMULARIOS ===== */
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 500; }
        
        .form-control {
            width: 100%; padding: 14px 18px; background: rgba(255,255,255,0.07); border: 1px solid rgba(255,255,255,0.1);
            border-radius: var(--border-radius); color: white; font-size: 1rem; transition: var(--transition);
        }
        
        .form-control:focus {
            outline: none; border-color: #00c6ff; background: rgba(255,255,255,0.1);
            box-shadow: 0 0 0 3px rgba(0,198,255,0.1);
        }
        
        /* ===== RESPONSIVE ===== */
        @media (max-width: 768px) {
            .header { flex-direction: column; gap: 20px; }
            .links-grid { grid-template-columns: 1fr; }
            .dashboard-grid { grid-template-columns: 1fr; }
            .tabs { flex-direction: column; }
            .tab-btn { width: 100%; }
        }
        
        /* ===== UTILIDADES ===== */
        .text-muted { color: rgba(255,255,255,0.5); }
        .mt-3 { margin-top: 15px; }
        .mb-3 { margin-bottom: 15px; }
        .btn-block { width: 100%; }
    </style>
</head>
<body>
    <div class="container">
        <!-- HEADER CORPORATIVO -->
        <header class="header">
            <div class="brand">
                <div class="logo">
                    <i class="fas fa-chalkboard-teacher"></i>
                </div>
                <div class="brand-info">
                    <h1>Agenda Digital DRTE - Sistema Profesional</h1>
                    <p>Departamento de Investigaci√≥n, Desarrollo e Implementaci√≥n | MEP Costa Rica</p>
                    <p style="font-size: 0.8rem; margin-top: 5px;">
                        <i class="fas fa-user-tie"></i> Asesor Nacional: Kevin S√°nchez Bogar√≠n
                    </p>
                </div>
            </div>
            <div class="header-controls">
                <div id="current-datetime" style="font-size: 0.9rem; color: rgba(255,255,255,0.7);">
                    <i class="fas fa-clock"></i> Cargando...
                </div>
            </div>
        </header>

        <!-- PANEL DE ENLACES INSTITUCIONALES MEP -->
        <div class="external-links-panel">
            <h3 style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                <i class="fas fa-external-link-alt"></i> Enlaces Institucionales MEP
            </h3>
            <div class="links-grid">
                <a href="https://outlook.office.com/" class="external-link" target="_blank">
                    <i class="fas fa-envelope" style="color: #0078D4;"></i> Correo Institucional MEP
                </a>
                <a href="https://m365.cloud.microsoft/launch/onenote?auth=2" class="external-link" target="_blank">
                    <i class="fas fa-sticky-note" style="color: #80397b;"></i> OneNote Institucional
                </a>
                <a href="https://adminmepcr-my.sharepoint.com/:o:/r/personal/kevin_sanchez_bogarin_mep_go_cr/Documents/Notebooks/Informe%20Teletrabajo%20Kevin%20S%C3%A1nchez%20B_2025?d=w15530935b0e744b7bac3d76e43abfd42&csf=1&web=1&e=w3sAuX" 
                   class="external-link" target="_blank">
                    <i class="fas fa-book" style="color: #00a859;"></i> Bit√°cora Teletrabajo 2025
                </a>
                <a href="https://www.youtube.com/" class="external-link" target="_blank">
                    <i class="fab fa-youtube" style="color: #ff0000;"></i> YouTube (Investigaci√≥n)
                </a>
                <a href="https://www.symbaloo.com/home/mix/13eP7Bh97Y" class="external-link" target="_blank">
                    <i class="fas fa-th-large" style="color: #ff6600;"></i> Symbaloo Dashboard
                </a>
                <a href="https://pnft.mep.go.cr/asesoriapnft/app/home" class="external-link" target="_blank">
                    <i class="fas fa-chart-line" style="color: #0066cc;"></i> Sistema PNFT MEP
                </a>
                <a href="https://adminmepcr.sharepoint.com/sites/DRTE-Intranet/DOCUMENTOSASESORESDRTE/Forms/AllItems.aspx?id=%2Fsites%2FDRTE%2DIntranet%2FDOCUMENTOSASESORESDRTE%2FINFORMES%2Fkevin%2Esanchez%2Ebogarin%40mep%2Ego%2Ecr&viewid=13f17d12%2Dcdb7%2D4a0b%2D95e3%2Dbc4ca8b3c9ac" 
                   class="external-link" target="_blank">
                    <i class="fas fa-folder" style="color: #ff5722;"></i> Documentos DRTE
                </a>
                <a href="https://adminmepcr.sharepoint.com/sites/DiseoMallaCurricular-Enmallados/Documentos%20compartidos/Forms/AllItems.aspx?id=%2Fsites%2FDiseoMallaCurricular%2DEnmallados%2FDocumentos%20compartidos%2FExpediente%20PNFT%2F2025&viewid=254250fe%2D08d1%2D4bf0%2D9c90%2Deb1b60941e1c&e=5%3A0b732e76068e4cb0a415be46f8839e65&sharingv2=true&fromShare=true&at=9" 
                   class="external-link" target="_blank">
                    <i class="fas fa-graduation-cap" style="color: #9c27b0;"></i> Dise√±o Malla Curricular
                </a>
                <a href="https://adminmepcr.sharepoint.com/sites/repositorio-pnft" class="external-link" target="_blank">
                    <i class="fas fa-database" style="color: #4caf50;"></i> Repositorio PNFT
                </a>
                <a href="https://www.mep.go.cr/" class="external-link" target="_blank">
                    <i class="fas fa-school" style="color: #00b894;"></i> MEP Oficial
                </a>
                <a href="https://www.drte.mep.go.cr/" class="external-link" target="_blank">
                    <i class="fas fa-chalkboard-teacher" style="color: #0984e3;"></i> DRTE Portal
                </a>
            </div>
        </div>

        <!-- SISTEMA DE PESTA√ëAS PRINCIPAL -->
        <div class="tabs-container">
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('bitacora')">
                    <i class="fas fa-book"></i> Bit√°cora Diaria
                </button>
                <button class="tab-btn" onclick="switchTab('tareas')">
                    <i class="fas fa-tasks"></i> Gesti√≥n de Tareas
                </button>
                <button class="tab-btn" onclick="switchTab('archivos')">
                    <i class="fas fa-folder"></i> Archivos por Fecha
                </button>
                <button class="tab-btn" onclick="switchTab('reportes')">
                    <i class="fas fa-chart-bar"></i> Reportes
                </button>
                <button class="tab-btn" onclick="switchTab('correo')">
                    <i class="fas fa-envelope"></i> Correo MEP
                </button>
            </div>

            <!-- PESTA√ëA BIT√ÅCORA DIARIA -->
            <div id="tab-bitacora" class="tab-content active">
                <div class="card">
                    <div class="card-header">
                        <h2><i class="fas fa-book-open"></i> Bit√°cora Diaria Profesional</h2>
                        <button class="btn btn-primary" onclick="saveJournal()">
                            <i class="fas fa-save"></i> Guardar Bit√°cora
                        </button>
                    </div>
                    
                    <div class="journal-date-selector">
                        <input type="date" id="journal-date" class="form-control" style="width: 200px;">
                        <button class="btn btn-secondary" onclick="loadTodayJournal()">
                            <i class="fas fa-calendar-day"></i> Hoy
                        </button>
                        <button class="btn btn-secondary" onclick="loadJournal()">
                            <i class="fas fa-search"></i> Cargar
                        </button>
                    </div>
                    
                    <div class="journal-editor">
                        <div class="journal-toolbar">
                            <select id="journal-category" class="form-control" style="width: 200px;">
                                <option value="general">üìã Actividades Generales</option>
                                <option value="pntf">üìä PNFT - Actividades Principales</option>
                                <option value="reunion">üë• Reuniones & Coordinaciones</option>
                                <option value="capacitacion">üéì Capacitaci√≥n & Talleres</option>
                                <option value="dise√±o">üé® Dise√±o Instruccional</option>
                                <option value="informe">üìÑ Informes & Documentaci√≥n</option>
                                <option value="sistema">üíª Sistemas & Actualizaci√≥n</option>
                                <option value="teletrabajo">üè† Teletrabajo</option>
                            </select>
                            
                            <input type="text" id="journal-title" class="form-control" placeholder="T√≠tulo de la actividad" style="flex: 1;">
                            
                            <input type="time" id="journal-time" class="form-control" style="width: 150px;">
                            
                            <button class="toolbar-btn" onclick="insertTemplate('actividad')">
                                <i class="fas fa-plus"></i> Nueva Actividad
                            </button>
                            
                            <button class="toolbar-btn" onclick="attachFileToJournal()">
                                <i class="fas fa-paperclip"></i> Adjuntar Archivo
                            </button>
                        </div>
                        
                        <div id="journal-content" style="padding: 20px; min-height: 300px;">
                            <!-- Contenido de la bit√°cora se generar√° aqu√≠ -->
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <h3 style="margin-bottom: 15px;">Resumen del D√≠a</h3>
                        <textarea id="journal-summary" class="form-control" rows="4" 
                                  placeholder="Escribe aqu√≠ el resumen ejecutivo del d√≠a..."></textarea>
                    </div>
                    
                    <div class="file-preview-container" id="journal-attachments" style="margin-top: 20px;">
                        <!-- Archivos adjuntos aparecer√°n aqu√≠ -->
                    </div>
                </div>
            </div>

            <!-- PESTA√ëA GESTI√ìN DE ARCHIVOS POR FECHA -->
            <div id="tab-archivos" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h2><i class="fas fa-folder-tree"></i> Sistema de Archivos Organizados por Fecha</h2>
                        <button class="btn btn-primary" onclick="openFileUpload()">
                            <i class="fas fa-cloud-upload-alt"></i> Subir Archivos
                        </button>
                    </div>
                    
                    <div class="file-date-navigation">
                        <button class="btn btn-secondary" onclick="navigateDate('prev')">
                            <i class="fas fa-chevron-left"></i> Anterior
                        </button>
                        
                        <div class="date-breadcrumb">
                            <span id="current-year" style="font-weight: bold;"></span>
                            <i class="fas fa-chevron-right"></i>
                            <span id="current-month" style="font-weight: bold;"></span>
                            <i class="fas fa-chevron-right"></i>
                            <span id="current-day" style="font-weight: bold;"></span>
                        </div>
                        
                        <button class="btn btn-secondary" onclick="navigateDate('next')">
                            Siguiente <i class="fas fa-chevron-right"></i>
                        </button>
                        
                        <input type="date" id="file-date-selector" class="form-control" style="width: 200px;">
                        <button class="btn btn-secondary" onclick="goToSelectedDate()">
                            <i class="fas fa-search"></i> Ir
                        </button>
                    </div>
                    
                    <!-- SISTEMA DE SUBIDA MEJORADO -->
                    <div class="file-upload-system" id="file-drop-area" 
                         onclick="document.getElementById('file-upload-input').click()"
                         ondragover="handleDragOver(event)"
                         ondragleave="handleDragLeave(event)"
                         ondrop="handleFileDrop(event)">
                        <i class="fas fa-cloud-upload-alt fa-3x" style="margin-bottom: 20px;"></i>
                        <h3>Arrastra y suelta archivos aqu√≠</h3>
                        <p>o haz clic para seleccionar</p>
                        <p class="text-muted">Formatos: PDF, DOC, DOCX, XLS, XLSX, JPG, PNG, MP4, ZIP (M√°x. 50MB)</p>
                        <input type="file" id="file-upload-input" multiple style="display: none;" 
                               accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png,.mp4,.zip">
                    </div>
                    
                    <!-- ESTRUCTURA DE CARPETAS POR FECHA -->
                    <div class="file-structure" id="file-structure">
                        <!-- Estructura generada din√°micamente -->
                    </div>
                    
                    <!-- ESTAD√çSTICAS DE ARCHIVOS -->
                    <div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div class="stat-item">
                            <div class="stat-icon" style="background: rgba(0,184,148,0.2); color: var(--color-success);">
                                <i class="fas fa-database"></i>
                            </div>
                            <div class="stat-info">
                                <div class="stat-label">Total Archivos</div>
                                <div class="stat-value" id="total-files-count">0</div>
                            </div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-icon" style="background: rgba(9,132,227,0.2); color: var(--color-info);">
                                <i class="fas fa-calendar"></i>
                            </div>
                            <div class="stat-info">
                                <div class="stat-label">D√≠as con Archivos</div>
                                <div class="stat-value" id="days-with-files">0</div>
                            </div>
                        </div>
                        <div class="stat-icon" style="background: rgba(155,89,182,0.2); color: #9b59b6;">
                            <i class="fas fa-hdd"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-label">Espacio Usado</div>
                            <div class="stat-value" id="storage-used">0 MB</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PESTA√ëA CORREO MEP -->
            <div id="tab-correo" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h2><i class="fas fa-envelope-open-text"></i> Sistema de Correo MEP Profesional</h2>
                    </div>
                    
                    <div style="padding: 20px;">
                        <div class="form-group">
                            <label class="form-label">Plantilla de Correo</label>
                            <select id="email-template" class="form-control" onchange="loadEmailTemplate()">
                                <option value="">Seleccionar plantilla</option>
                                <option value="informe_diario">üìã Informe Diario de Actividades</option>
                                <option value="informe_semanal">üìÖ Informe Semanal de Avances</option>
                                <option value="solicitud_reunion">üë• Solicitud de Reuni√≥n</option>
                                <option value="envio_documentos">üìé Env√≠o de Documentos</option>
                                <option value="reporte_pnft">üìä Reporte PNFT</option>
                                <option value="teletrabajo">üè† Reporte Teletrabajo</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Destinatario</label>
                            <select id="email-recipient" class="form-control">
                                <option value="supervisor">Supervisor Inmediato</option>
                                <option value="equipo">Equipo DRTE</option>
                                <option value="coordinacion">Coordinaci√≥n PNFT</option>
                                <option value="personal">Correo Personal</option>
                                <option value="custom">Personalizado...</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Asunto</label>
                            <input type="text" id="email-subject" class="form-control" placeholder="Asunto del correo">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Contenido del Correo</label>
                            <div id="email-editor" style="min-height: 300px; background: white; color: black; border-radius: var(--border-radius);"></div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Adjuntar desde Bit√°cora</label>
                            <div id="email-attachments">
                                <!-- Archivos para adjuntar -->
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 15px; margin-top: 30px;">
                            <button class="btn btn-email btn-block" onclick="sendViaOutlook()">
                                <i class="fas fa-paper-plane"></i> Abrir en Outlook MEP
                            </button>
                            <button class="btn btn-primary btn-block" onclick="saveEmailDraft()">
                                <i class="fas fa-save"></i> Guardar Borrador
                            </button>
                            <button class="btn btn-print btn-block" onclick="printEmail()">
                                <i class="fas fa-print"></i> Imprimir Correo
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // SISTEMA AGENDA DRTE DEFINITIVO
        // ============================================
        
        class AgendaDRTEProfessional {
            constructor() {
                this.version = '5.0.0';
                this.currentDate = new Date();
                this.journalDate = new Date();
                this.fileSystem = new FileSystemManager();
                this.init();
            }
            
            async init() {
                // Inicializar sistema
                this.updateDateTime();
                setInterval(() => this.updateDateTime(), 1000);
                
                // Cargar datos
                await this.loadData();
                
                // Configurar fecha inicial
                document.getElementById('journal-date').value = this.formatDateForInput(this.journalDate);
                this.updateDateNavigation();
                
                // Inicializar editor de correo
                this.initEmailEditor();
                
                console.log('‚úÖ Sistema Agenda DRTE Professional inicializado');
            }
            
            // ============================================
            // BIT√ÅCORA DIARIA COMPLETA
            // ============================================
            
            async saveJournal() {
                try {
                    const date = document.getElementById('journal-date').value;
                    const title = document.getElementById('journal-title').value;
                    const category = document.getElementById('journal-category').value;
                    const time = document.getElementById('journal-time').value;
                    const summary = document.getElementById('journal-summary').value;
                    const content = document.getElementById('journal-content').innerHTML;
                    
                    if (!date) {
                        throw new Error('Por favor seleccione una fecha');
                    }
                    
                    const journalEntry = {
                        id: `journal_${date.replace(/-/g, '')}`,
                        date: date,
                        title: title || 'Bit√°cora del d√≠a',
                        category: category,
                        time: time || new Date().toLocaleTimeString('es-CR', {hour: '2-digit', minute:'2-digit'}),
                        content: content,
                        summary: summary,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString(),
                        attachments: this.getCurrentAttachments()
                    };
                    
                    // Guardar en IndexedDB
                    await this.fileSystem.saveJournalEntry(journalEntry);
                    
                    // Actualizar interfaz
                    this.showNotification('Bit√°cora guardada', 'La entrada ha sido guardada exitosamente', 'success');
                    
                    // Generar backup autom√°tico
                    this.backupJournalEntry(journalEntry);
                    
                } catch (error) {
                    this.showNotification('Error', error.message, 'error');
                }
            }
            
            async loadJournal() {
                try {
                    const date = document.getElementById('journal-date').value;
                    const entry = await this.fileSystem.getJournalEntry(date);
                    
                    if (entry) {
                        document.getElementById('journal-title').value = entry.title || '';
                        document.getElementById('journal-category').value = entry.category || 'general';
                        document.getElementById('journal-time').value = entry.time || '';
                        document.getElementById('journal-summary').value = entry.summary || '';
                        document.getElementById('journal-content').innerHTML = entry.content || '<p>Comienza tu bit√°cora aqu√≠...</p>';
                        
                        this.loadJournalAttachments(entry.attachments || []);
                        
                        this.showNotification('Bit√°cora cargada', 'Entrada recuperada exitosamente', 'success');
                    } else {
                        document.getElementById('journal-content').innerHTML = `
                            <h3>üìù Bit√°cora para ${this.formatDate(new Date(date))}</h3>
                            <p>No hay una entrada para esta fecha. Puedes comenzar una nueva.</p>
                            <hr>
                            <div class="journal-section">
                                <h4>üéØ Objetivos del D√≠a:</h4>
                                <ul>
                                    <li>Actividad 1</li>
                                    <li>Actividad 2</li>
                                    <li>Actividad 3</li>
                                </ul>
                            </div>
                            <div class="journal-section">
                                <h4>üìã Actividades Realizadas:</h4>
                                <ul>
                                    <li>[Descripci√≥n de actividad]</li>
                                </ul>
                            </div>
                            <div class="journal-section">
                                <h4>üìä Resultados Obtenidos:</h4>
                                <ul>
                                    <li>[Resultado 1]</li>
                                </ul>
                            </div>
                            <div class="journal-section">
                                <h4>üöÄ Pr√≥ximos Pasos:</h4>
                                <ul>
                                    <li>[Acci√≥n futura 1]</li>
                                </ul>
                            </div>
                        `;
                    }
                    
                } catch (error) {
                    console.error('Error cargando bit√°cora:', error);
                    this.showNotification('Error', 'No se pudo cargar la bit√°cora', 'error');
                }
            }
            
            loadTodayJournal() {
                const today = new Date();
                document.getElementById('journal-date').value = this.formatDateForInput(today);
                this.loadJournal();
            }
            
            insertTemplate(templateType) {
                const contentDiv = document.getElementById('journal-content');
                let template = '';
                
                switch(templateType) {
                    case 'actividad':
                        template = `
                            <div class="activity-entry" style="margin-bottom: 20px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <h4 style="margin: 0;">Nueva Actividad</h4>
                                    <span style="font-size: 0.9rem; color: rgba(255,255,255,0.7);">${new Date().toLocaleTimeString('es-CR', {hour: '2-digit', minute:'2-digit'})}</span>
                                </div>
                                <p><strong>Descripci√≥n:</strong> [Describa la actividad realizada]</p>
                                <p><strong>Objetivo:</strong> [Objetivo de la actividad]</p>
                                <p><strong>Resultados:</strong> [Resultados obtenidos]</p>
                                <p><strong>Evidencias:</strong> [Adjunte evidencias si aplica]</p>
                                <p><strong>Tiempo dedicado:</strong> [Horas] horas</p>
                            </div>
                        `;
                        break;
                        
                    case 'reunion':
                        template = `
                            <div class="meeting-entry" style="margin-bottom: 20px; padding: 15px; background: rgba(9,132,227,0.1); border-radius: 8px;">
                                <h4>üë• Reuni√≥n/Coordinaci√≥n</h4>
                                <p><strong>Participantes:</strong> [Nombres de participantes]</p>
                                <p><strong>Tema:</strong> [Tema principal]</p>
                                <p><strong>Acuerdos:</strong> [Lista de acuerdos]</p>
                                <p><strong>Acciones pendientes:</strong> [Acciones a seguir]</p>
                                <p><strong>Pr√≥xima reuni√≥n:</strong> [Fecha si aplica]</p>
                            </div>
                        `;
                        break;
                }
                
                contentDiv.innerHTML += template;
            }
            
            // ============================================
            // SISTEMA DE ARCHIVOS POR FECHA
            // ============================================
            
            async uploadFiles(files) {
                try {
                    const date = document.getElementById('file-date-selector').value || this.formatDateForInput(this.currentDate);
                    
                    for (const file of files) {
                        // Crear estructura de fecha
                        const dateParts = date.split('-');
                        const year = dateParts[0];
                        const month = dateParts[1];
                        const day = dateParts[2];
                        
                        // Guardar archivo con metadatos de fecha
                        await this.fileSystem.saveFile(file, {
                            year: year,
                            month: month,
                            day: day,
                            date: date,
                            category: 'general'
                        });
                    }
                    
                    // Actualizar interfaz
                    this.updateFileStructure();
                    this.updateFileStats();
                    
                    this.showNotification('Archivos subidos', `${files.length} archivo(s) guardados exitosamente`, 'success');
                    
                } catch (error) {
                    this.showNotification('Error', error.message, 'error');
                }
            }
            
            async updateFileStructure() {
                try {
                    const files = await this.fileSystem.getAllFiles();
                    const structure = {};
                    
                    // Organizar archivos por a√±o/mes/d√≠a
                    files.forEach(file => {
                        if (!file.metadata) return;
                        
                        const { year, month, day } = file.metadata;
                        
                        if (!structure[year]) structure[year] = {};
                        if (!structure[year][month]) structure[year][month] = {};
                        if (!structure[year][month][day]) structure[year][month][day] = [];
                        
                        structure[year][month][day].push(file);
                    });
                    
                    // Renderizar estructura
                    const container = document.getElementById('file-structure');
                    container.innerHTML = '';
                    
                    Object.keys(structure).sort((a, b) => b - a).forEach(year => {
                        const yearDiv = this.createFolderElement('year', year, structure[year]);
                        container.appendChild(yearDiv);
                    });
                    
                } catch (error) {
                    console.error('Error actualizando estructura:', error);
                }
            }
            
            createFolderElement(type, name, content) {
                const div = document.createElement('div');
                div.className = 'folder';
                
                let icon = 'üìÅ';
                let title = name;
                
                switch(type) {
                    case 'year':
                        icon = 'üìÖ';
                        title = `A√±o ${name}`;
                        break;
                    case 'month':
                        icon = 'üìÜ';
                        const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                                          'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
                        title = `${monthNames[parseInt(name) - 1]}`;
                        break;
                    case 'day':
                        icon = 'üìù';
                        title = `D√≠a ${name}`;
                        break;
                }
                
                div.innerHTML = `
                    <div class="folder-header" onclick="this.parentElement.querySelector('.folder-content').classList.toggle('expanded')">
                        <span style="font-size: 1.2rem;">${icon}</span>
                        <span style="flex: 1;">${title}</span>
                        <span class="file-count">${this.countFiles(content)} archivos</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="folder-content">
                        ${this.renderFolderContent(type, content)}
                    </div>
                `;
                
                return div;
            }
            
            countFiles(content) {
                if (Array.isArray(content)) {
                    return content.length;
                } else if (typeof content === 'object') {
                    let total = 0;
                    Object.values(content).forEach(subContent => {
                        total += this.countFiles(subContent);
                    });
                    return total;
                }
                return 0;
            }
            
            renderFolderContent(type, content) {
                if (Array.isArray(content)) {
                    return content.map(file => `
                        <div class="file-item" data-file-id="${file.id}">
                            <i class="fas ${this.getFileIcon(file.type)}"></i>
                            <span style="flex: 1;">${file.name}</span>
                            <span style="font-size: 0.8rem; color: rgba(255,255,255,0.7);">
                                ${this.formatFileSize(file.size)}
                            </span>
                            <button class="toolbar-btn" onclick="downloadFile('${file.id}')" title="Descargar">
                                <i class="fas fa-download"></i>
                            </button>
                            <button class="toolbar-btn" onclick="previewFile('${file.id}')" title="Vista previa">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="toolbar-btn" onclick="deleteFile('${file.id}')" title="Eliminar">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `).join('');
                } else {
                    let html = '';
                    Object.keys(content).sort((a, b) => {
                        if (type === 'year') return b - a;
                        if (type === 'month') return b - a;
                        if (type === 'day') return b - a;
                        return 0;
                    }).forEach(key => {
                        const subType = type === 'year' ? 'month' : type === 'month' ? 'day' : 'file';
                        html += this.createFolderElement(subType, key, content[key]).outerHTML;
                    });
                    return html;
                }
            }
            
            async updateFileStats() {
                try {
                    const files = await this.fileSystem.getAllFiles();
                    const totalSize = files.reduce((sum, file) => sum + file.size, 0);
                    
                    // Contar d√≠as √∫nicos con archivos
                    const uniqueDates = new Set();
                    files.forEach(file => {
                        if (file.metadata && file.metadata.date) {
                            uniqueDates.add(file.metadata.date);
                        }
                    });
                    
                    document.getElementById('total-files-count').textContent = files.length;
                    document.getElementById('days-with-files').textContent = uniqueDates.size;
                    document.getElementById('storage-used').textContent = this.formatFileSize(totalSize);
                    
                } catch (error) {
                    console.error('Error actualizando estad√≠sticas:', error);
                }
            }
            
            // ============================================
            // SISTEMA DE CORREO MEP
            // ============================================
            
            initEmailEditor() {
                // Editor simple para correos
                const editor = document.getElementById('email-editor');
                editor.contentEditable = true;
                editor.style.padding = '20px';
                editor.innerHTML = `
                    <p><strong>Estimado(a) Supervisor(a):</strong></p>
                    <p>Por este medio le presento mi informe de actividades correspondiente al d√≠a de hoy.</p>
                    <p><strong>Actividades realizadas:</strong></p>
                    <ul>
                        <li>[Describa actividad 1]</li>
                        <li>[Describa actividad 2]</li>
                    </ul>
                    <p><strong>Resultados obtenidos:</strong></p>
                    <ul>
                        <li>[Resultado 1]</li>
                    </ul>
                    <p><strong>Observaciones:</strong></p>
                    <p>[Observaciones importantes]</p>
                    <p>Quedo atento(a) a sus comentarios.</p>
                    <p><strong>Atentamente,</strong><br>
                    Kevin S√°nchez Bogar√≠n<br>
                    Asesor Nacional<br>
                    Departamento de Investigaci√≥n, Desarrollo e Implementaci√≥n<br>
                    MEP - Costa Rica</p>
                `;
            }
            
            loadEmailTemplate() {
                const template = document.getElementById('email-template').value;
                const editor = document.getElementById('email-editor');
                
                let content = '';
                let subject = '';
                
                switch(template) {
                    case 'informe_diario':
                        subject = 'Informe Diario de Actividades - ' + this.formatDate(new Date());
                        content = this.generateDailyReport();
                        break;
                        
                    case 'informe_semanal':
                        subject = 'Informe Semanal de Avances - Semana ' + this.getWeekNumber();
                        content = this.generateWeeklyReport();
                        break;
                        
                    case 'solicitud_reunion':
                        subject = 'Solicitud de Reuni√≥n - Tema por definir';
                        content = this.generateMeetingRequest();
                        break;
                }
                
                if (content) {
                    editor.innerHTML = content;
                    document.getElementById('email-subject').value = subject;
                }
            }
            
            generateDailyReport() {
                const date = new Date();
                return `
                    <p><strong>INFORME DIARIO DE ACTIVIDADES</strong></p>
                    <p><strong>Fecha:</strong> ${this.formatDate(date)}</p>
                    <p><strong>Asesor:</strong> Kevin S√°nchez Bogar√≠n</p>
                    <p><strong>Departamento:</strong> Investigaci√≥n, Desarrollo e Implementaci√≥n</p>
                    <hr>
                    <p><strong>1. ACTIVIDADES PRINCIPALES REALIZADAS:</strong></p>
                    <ul>
                        <li>[Actividad PNFT 1]</li>
                        <li>[Actividad PNFT 2]</li>
                        <li>[Coordinaciones realizadas]</li>
                        <li>[Revisi√≥n de documentos]</li>
                    </ul>
                    <p><strong>2. RESULTADOS OBTENIDOS:</strong></p>
                    <ul>
                        <li>[Resultado 1]</li>
                        <li>[Resultado 2]</li>
                    </ul>
                    <p><strong>3. DIFICULTADES ENCONTRADAS:</strong></p>
                    <ul>
                        <li>[Dificultad 1]</li>
                        <li>[Dificultad 2]</li>
                    </ul>
                    <p><strong>4. ACCIONES PLANIFICADAS PARA MA√ëANA:</strong></p>
                    <ul>
                        <li>[Acci√≥n 1]</li>
                        <li>[Acci√≥n 2]</li>
                    </ul>
                    <hr>
                    <p><strong>Observaciones:</strong></p>
                    <p>[Observaciones importantes del d√≠a]</p>
                    <p>Documentos adjuntos: [Lista de documentos adjuntos]</p>
                    <p><strong>Atentamente,</strong><br>
                    Kevin S√°nchez Bogar√≠n<br>
                    Asesor Nacional<br>
                    MEP - Costa Rica</p>
                `;
            }
            
            sendViaOutlook() {
                const subject = encodeURIComponent(document.getElementById('email-subject').value);
                const body = encodeURIComponent(document.getElementById('email-editor').innerHTML);
                const recipient = document.getElementById('email-recipient').value;
                
                let to = '';
                switch(recipient) {
                    case 'supervisor':
                        to = 'supervisor@mep.go.cr';
                        break;
                    case 'equipo':
                        to = 'equipo.drte@mep.go.cr';
                        break;
                    case 'coordinacion':
                        to = 'coordinacion.pnft@mep.go.cr';
                        break;
                    default:
                        to = '';
                }
                
                const mailtoLink = `https://outlook.office.com/mail/deeplink/compose?to=${to}&subject=${subject}&body=${body}`;
                window.open(mailtoLink, '_blank');
                
                this.showNotification('Correo preparado', 'Redirigiendo a Outlook MEP...', 'success');
            }
            
            // ============================================
            // UTILIDADES
            // ============================================
            
            formatDate(date) {
                return date.toLocaleDateString('es-CR', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            }
            
            formatDateForInput(date) {
                return date.toISOString().split('T')[0];
            }
            
            formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }
            
            getFileIcon(fileType) {
                if (fileType.includes('pdf')) return 'fa-file-pdf';
                if (fileType.includes('word') || fileType.includes('document')) return 'fa-file-word';
                if (fileType.includes('excel') || fileType.includes('spreadsheet')) return 'fa-file-excel';
                if (fileType.includes('image')) return 'fa-file-image';
                if (fileType.includes('video')) return 'fa-file-video';
                return 'fa-file';
            }
            
            updateDateTime() {
                const now = new Date();
                document.getElementById('current-datetime').innerHTML = 
                    `<i class="fas fa-clock"></i> ${now.toLocaleString('es-CR', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    })} UTC-6 üá®üá∑`;
            }
            
            updateDateNavigation() {
                const year = this.currentDate.getFullYear();
                const month = this.currentDate.toLocaleDateString('es-CR', { month: 'long' });
                const day = this.currentDate.getDate();
                
                document.getElementById('current-year').textContent = year;
                document.getElementById('current-month').textContent = month;
                document.getElementById('current-day').textContent = day;
                document.getElementById('file-date-selector').value = this.formatDateForInput(this.currentDate);
            }
            
            navigateDate(direction) {
                if (direction === 'prev') {
                    this.currentDate.setDate(this.currentDate.getDate() - 1);
                } else {
                    this.currentDate.setDate(this.currentDate.getDate() + 1);
                }
                this.updateDateNavigation();
                this.updateFileStructure();
            }
            
            goToSelectedDate() {
                const selectedDate = document.getElementById('file-date-selector').value;
                if (selectedDate) {
                    this.currentDate = new Date(selectedDate);
                    this.updateDateNavigation();
                    this.updateFileStructure();
                }
            }
            
            showNotification(title, message, type = 'info') {
                // Crear notificaci√≥n simple
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 15px 20px;
                    background: ${type === 'success' ? '#00b894' : type === 'error' ? '#d63031' : '#0984e3'};
                    color: white;
                    border-radius: var(--border-radius);
                    box-shadow: var(--box-shadow);
                    z-index: 10000;
                    animation: slideIn 0.3s ease;
                `;
                
                notification.innerHTML = `
                    <strong>${title}</strong>
                    <p style="margin: 5px 0 0; font-size: 0.9rem;">${message}</p>
                `;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => notification.remove(), 300);
                }, 5000);
            }
            
            async loadData() {
                try {
                    await this.fileSystem.init();
                    await this.updateFileStructure();
                    await this.updateFileStats();
                    this.loadJournal();
                } catch (error) {
                    console.error('Error cargando datos:', error);
                }
            }
            
            getCurrentAttachments() {
                // Obtener archivos adjuntos actuales
                const attachments = [];
                const container = document.getElementById('journal-attachments');
                const fileItems = container.querySelectorAll('.file-item');
                
                fileItems.forEach(item => {
                    const fileId = item.dataset.fileId;
                    if (fileId) {
                        attachments.push(fileId);
                    }
                });
                
                return attachments;
            }
            
            loadJournalAttachments(attachmentIds) {
                const container = document.getElementById('journal-attachments');
                container.innerHTML = '';
                
                // Cargar informaci√≥n de archivos adjuntos
                attachmentIds.forEach(async fileId => {
                    const file = await this.fileSystem.getFile(fileId);
                    if (file) {
                        const div = document.createElement('div');
                        div.className = 'file-item';
                        div.dataset.fileId = fileId;
                        div.innerHTML = `
                            <i class="fas ${this.getFileIcon(file.type)}"></i>
                            <span>${file.name}</span>
                            <button class="toolbar-btn" onclick="downloadFile('${fileId}')">
                                <i class="fas fa-download"></i>
                            </button>
                        `;
                        container.appendChild(div);
                    }
                });
            }
            
            backupJournalEntry(entry) {
                // Crear backup en localStorage
                const backups = JSON.parse(localStorage.getItem('journal_backups') || '[]');
                backups.push({
                    ...entry,
                    backedUpAt: new Date().toISOString()
                });
                
                // Mantener solo los √∫ltimos 100 backups
                if (backups.length > 100) {
                    backups.shift();
                }
                
                localStorage.setItem('journal_backups', JSON.stringify(backups));
            }
            
            getWeekNumber() {
                const date = new Date();
                const firstDayOfYear = new Date(date.getFullYear(), 0, 1);
                const pastDaysOfYear = (date - firstDayOfYear) / 86400000;
                return Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
            }
        }
        
        // ============================================
        // SISTEMA DE ARCHIVOS CON INDEXEDDB
        // ============================================
        
        class FileSystemManager {
            constructor() {
                this.db = null;
                this.dbName = 'AgendaDRTE_Files_v2';
                this.dbVersion = 2;
            }
            
            async init() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, this.dbVersion);
                    
                    request.onerror = () => reject('Error al abrir IndexedDB');
                    
                    request.onsuccess = (event) => {
                        this.db = event.target.result;
                        console.log('‚úÖ IndexedDB inicializada');
                        resolve();
                    };
                    
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        
                        // Crear almac√©n para archivos
                        if (!db.objectStoreNames.contains('files')) {
                            const filesStore = db.createObjectStore('files', { keyPath: 'id' });
                            filesStore.createIndex('date', 'metadata.date', { unique: false });
                            filesStore.createIndex('year', 'metadata.year', { unique: false });
                            filesStore.createIndex('month', 'metadata.month', { unique: false });
                            filesStore.createIndex('day', 'metadata.day', { unique: false });
                        }
                        
                        // Crear almac√©n para bit√°coras
                        if (!db.objectStoreNames.contains('journals')) {
                            const journalsStore = db.createObjectStore('journals', { keyPath: 'id' });
                            journalsStore.createIndex('date', 'date', { unique: true });
                        }
                    };
                });
            }
            
            async saveFile(file, metadata = {}) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['files'], 'readwrite');
                    const store = transaction.objectStore('files');
                    
                    const reader = new FileReader();
                    
                    reader.onload = async (event) => {
                        const fileData = {
                            id: Date.now() + '-' + Math.random().toString(36).substr(2, 9),
                            name: file.name,
                            type: file.type,
                            size: file.size,
                            data: event.target.result,
                            metadata: {
                                ...metadata,
                                uploadedAt: new Date().toISOString(),
                                originalName: file.name
                            }
                        };
                        
                        const request = store.put(fileData);
                        
                        request.onsuccess = () => {
                            console.log('üìÅ Archivo guardado:', file.name);
                            resolve(fileData.id);
                        };
                        
                        request.onerror = () => reject('Error al guardar archivo');
                    };
                    
                    reader.onerror = () => reject('Error al leer archivo');
                    reader.readAsArrayBuffer(file);
                });
            }
            
            async getFile(fileId) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['files'], 'readonly');
                    const store = transaction.objectStore('files');
                    const request = store.get(fileId);
                    
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject('Error al obtener archivo');
                });
            }
            
            async getAllFiles() {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['files'], 'readonly');
                    const store = transaction.objectStore('files');
                    const request = store.getAll();
                    
                    request.onsuccess = () => resolve(request.result || []);
                    request.onerror = () => reject('Error al obtener archivos');
                });
            }
            
            async getFilesByDate(date) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['files'], 'readonly');
                    const store = transaction.objectStore('files');
                    const index = store.index('date');
                    const request = index.getAll(date);
                    
                    request.onsuccess = () => resolve(request.result || []);
                    request.onerror = () => reject('Error al obtener archivos por fecha');
                });
            }
            
            async deleteFile(fileId) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['files'], 'readwrite');
                    const store = transaction.objectStore('files');
                    const request = store.delete(fileId);
                    
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject('Error al eliminar archivo');
                });
            }
            
            async saveJournalEntry(entry) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['journals'], 'readwrite');
                    const store = transaction.objectStore('journals');
                    const request = store.put(entry);
                    
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject('Error al guardar bit√°cora');
                });
            }
            
            async getJournalEntry(date) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['journals'], 'readonly');
                    const store = transaction.objectStore('journals');
                    const index = store.index('date');
                    const request = index.get(date);
                    
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject('Error al obtener bit√°cora');
                });
            }
            
            async getAllJournals() {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['journals'], 'readonly');
                    const store = transaction.objectStore('journals');
                    const request = store.getAll();
                    
                    request.onsuccess = () => resolve(request.result || []);
                    request.onerror = () => reject('Error al obtener bit√°coras');
                });
            }
        }
        
        // ============================================
        // INICIALIZACI√ìN GLOBAL
        // ============================================
        
        let agendaSystem;
        
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                agendaSystem = new AgendaDRTEProfessional();
                
                // Hacer funciones globales
                window.agenda = agendaSystem;
                window.switchTab = switchTab;
                window.openFileUpload = openFileUpload;
                window.handleDragOver = handleDragOver;
                window.handleDragLeave = handleDragLeave;
                window.handleFileDrop = handleFileDrop;
                window.downloadFile = downloadFile;
                window.previewFile = previewFile;
                window.deleteFile = deleteFile;
                
                console.log('üöÄ Sistema Agenda DRTE Professional cargado');
                
            } catch (error) {
                console.error('‚ùå Error cr√≠tico:', error);
                alert('Error al cargar la aplicaci√≥n. Por favor, recarga la p√°gina.');
            }
        });
        
        // Funciones globales
        function switchTab(tabName) {
            // Ocultar todos los tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Desactivar todos los botones
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Mostrar tab seleccionado
            document.getElementById(`tab-${tabName}`).classList.add('active');
            event.target.classList.add('active');
        }
        
        function openFileUpload() {
            document.getElementById('file-upload-input').click();
        }
        
        async function handleFileDrop(event) {
            event.preventDefault();
            document.getElementById('file-drop-area').classList.remove('dragover');
            
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                await agendaSystem.uploadFiles(files);
            }
        }
        
        function handleDragOver(event) {
            event.preventDefault();
            document.getElementById('file-drop-area').classList.add('dragover');
        }
        
        function handleDragLeave(event) {
            event.preventDefault();
            document.getElementById('file-drop-area').classList.remove('dragover');
        }
        
        async function downloadFile(fileId) {
            try {
                const file = await agendaSystem.fileSystem.getFile(fileId);
                if (!file) {
                    throw new Error('Archivo no encontrado');
                }
                
                const blob = new Blob([file.data], { type: file.type });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = file.name;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                agendaSystem.showNotification('Descarga iniciada', `Descargando ${file.name}`, 'success');
                
            } catch (error) {
                agendaSystem.showNotification('Error', 'No se pudo descargar el archivo', 'error');
            }
        }
        
        async function previewFile(fileId) {
            try {
                const file = await agendaSystem.fileSystem.getFile(fileId);
                if (!file) {
                    throw new Error('Archivo no encontrado');
                }
                
                const blob = new Blob([file.data], { type: file.type });
                const url = URL.createObjectURL(blob);
                
                if (file.type.includes('pdf')) {
                    window.open(url, '_blank');
                } else if (file.type.includes('image')) {
                    const imgWindow = window.open('', '_blank');
                    imgWindow.document.write(`
                        <html>
                            <head><title>${file.name}</title></head>
                            <body style="margin:0; padding:20px; background:#1a1a2e;">
                                <img src="${url}" style="max-width:100%; max-height:90vh; display:block; margin:auto;">
                            </body>
                        </html>
                    `);
                } else {
                    window.open(url, '_blank');
                }
                
            } catch (error) {
                agendaSystem.showNotification('Error', 'No se pudo previsualizar el archivo', 'error');
            }
        }
        
        async function deleteFile(fileId) {
            if (!confirm('¬øEst√° seguro de eliminar este archivo?')) return;
            
            try {
                await agendaSystem.fileSystem.deleteFile(fileId);
                
                // Eliminar de la interfaz
                const element = document.querySelector(`[data-file-id="${fileId}"]`);
                if (element) {
                    element.remove();
                }
                
                agendaSystem.updateFileStats();
                agendaSystem.showNotification('Archivo eliminado', 'El archivo ha sido eliminado', 'success');
                
            } catch (error) {
                agendaSystem.showNotification('Error', 'No se pudo eliminar el archivo', 'error');
            }
        }
        
        // Configurar subida de archivos
        document.getElementById('file-upload-input').addEventListener('change', async function(e) {
            const files = Array.from(e.target.files);
            if (files.length > 0) {
                await agendaSystem.uploadFiles(files);
                e.target.value = ''; // Reset input
            }
        });
        
        // Configurar fecha de bit√°cora
        document.getElementById('journal-date').addEventListener('change', function() {
            agendaSystem.journalDate = new Date(this.value);
            agendaSystem.loadJournal();
        });
        
        // Configurar plantillas de correo
        document.getElementById('email-template').addEventListener('change', function() {
            agendaSystem.loadEmailTemplate();
        });
    </script>
</body>
</html>
