<!DOCTYPE html>
<html lang="es-CR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Agenda Digital DRTE - Sistema Integral de Gesti√≥n">
    <meta name="theme-color" content="#1a1a2e">
    <title>Agenda Digital DRTE | Sistema Profesional</title>
    
    <!-- ENLACES EXTERNOS DRTE (Como solicitaste) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/viewerjs/1.11.6/viewer.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/viewerjs/1.11.6/viewer.min.js"></script>
    
    <style>
        /* ===== ESTILOS PROFESIONALES MEJORADOS ===== */
        :root {
            --color-primary: #1a1a2e; --color-secondary: #16213e; --color-accent: #0f3460;
            --color-success: #00b894; --color-warning: #fdcb6e; --color-danger: #d63031;
            --color-info: #0984e3; --color-light: #f8f9fa; --color-dark: #2d3436;
            --border-radius: 12px; --box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            --transition: all 0.3s ease; --glass-bg: rgba(255,255,255,0.05);
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-secondary) 100%);
            color: var(--color-light);
            min-height: 100vh;
            line-height: 1.6;
        }
        
        /* ===== PANEL DE ENLACES EXTERNOS DRTE ===== */
        .external-links-panel {
            background: rgba(0,0,0,0.3);
            padding: 15px 30px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            gap: 25px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .external-link {
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            padding: 8px 15px;
            border-radius: 20px;
            transition: var(--transition);
            background: rgba(255,255,255,0.05);
        }
        
        .external-link:hover {
            background: rgba(255,255,255,0.1);
            color: white;
            transform: translateY(-2px);
        }
        
        /* ===== SISTEMA DE SUBIDA DE ARCHIVOS MEJORADO ===== */
        .file-upload-system {
            border: 2px dashed rgba(255,255,255,0.3);
            border-radius: var(--border-radius);
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            background: rgba(255,255,255,0.02);
            margin: 20px 0;
        }
        
        .file-upload-system.dragover {
            border-color: var(--color-success);
            background: rgba(0,184,148,0.1);
            transform: scale(1.02);
        }
        
        .file-preview-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .file-preview {
            background: rgba(255,255,255,0.08);
            border-radius: var(--border-radius);
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            transition: var(--transition);
            position: relative;
        }
        
        .file-preview:hover {
            background: rgba(255,255,255,0.12);
            transform: translateY(-5px);
        }
        
        .file-preview img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
        }
        
        .file-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        
        /* ===== VISOR DE ARCHIVOS PROFESIONAL ===== */
        #file-viewer-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
        }
        
        #file-viewer-modal.active {
            display: flex;
        }
        
        .file-viewer-content {
            width: 90%;
            height: 90%;
            background: var(--color-primary);
            border-radius: var(--border-radius);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .file-viewer-header {
            padding: 20px;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .file-viewer-body {
            flex: 1;
            padding: 20px;
            overflow: auto;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #pdf-viewer {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        #image-viewer {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        /* ===== SISTEMA DE IMPRESI√ìN PROFESIONAL ===== */
        @media print {
            .no-print {
                display: none !important;
            }
            
            .print-only {
                display: block !important;
            }
            
            body {
                background: white !important;
                color: black !important;
            }
            
            .card {
                box-shadow: none !important;
                border: 1px solid #ddd !important;
                background: white !important;
                color: black !important;
            }
        }
        
        .print-header {
            display: none;
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #000;
        }
        
        /* ===== BOTONES DE ACCI√ìN COMPLETOS ===== */
        .action-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin: 20px 0;
        }
        
        .btn-email {
            background: linear-gradient(135deg, #ea4335 0%, #d14836 100%);
            color: white;
        }
        
        .btn-print {
            background: linear-gradient(135deg, #4285f4 0%, #3367d6 100%);
            color: white;
        }
        
        /* Resto de estilos permanecen iguales (header, cards, etc.) */
        /* ... (todo el CSS anterior se mantiene, agregando estas mejoras) ... */
    </style>
</head>
<body>
    <!-- PANEL DE ENLACES EXTERNOS DRTE -->
    <div class="external-links-panel no-print">
        <a href="https://www.mep.go.cr/" class="external-link" target="_blank">
            <i class="fas fa-school"></i> MEP Oficial
        </a>
        <a href="https://www.drte.mep.go.cr/" class="external-link" target="_blank">
            <i class="fas fa-chalkboard-teacher"></i> DRTE Portal
        </a>
        <a href="https://drive.google.com/" class="external-link" target="_blank">
            <i class="fab fa-google-drive"></i> Google Drive
        </a>
        <a href="https://outlook.office.com/" class="external-link" target="_blank">
            <i class="fas fa-envelope"></i> Correo Institucional
        </a>
        <a href="https://teams.microsoft.com/" class="external-link" target="_blank">
            <i class="fas fa-video"></i> Microsoft Teams
        </a>
        <a href="https://meet.google.com/" class="external-link" target="_blank">
            <i class="fab fa-google"></i> Google Meet
        </a>
        <a href="https://trello.com/" class="external-link" target="_blank">
            <i class="fab fa-trello"></i> Trello
        </a>
        <a href="https://calendar.google.com/" class="external-link" target="_blank">
            <i class="fas fa-calendar"></i> Calendario
        </a>
    </div>
    
    <!-- VISOR DE ARCHIVOS PROFESIONAL -->
    <div id="file-viewer-modal">
        <div class="file-viewer-content">
            <div class="file-viewer-header">
                <h3 id="viewer-title">Visualizando Archivo</h3>
                <button class="btn btn-danger" onclick="closeViewer()">
                    <i class="fas fa-times"></i> Cerrar
                </button>
            </div>
            <div class="file-viewer-body">
                <iframe id="pdf-viewer" style="display: none;"></iframe>
                <img id="image-viewer" style="display: none;" alt="Vista previa de imagen">
                <div id="text-viewer" style="display: none; white-space: pre-wrap; font-family: monospace;"></div>
                <div id="other-file-viewer" style="display: none;">
                    <i class="fas fa-file fa-5x"></i>
                    <p>Este tipo de archivo no tiene vista previa disponible</p>
                    <button class="btn btn-primary" onclick="downloadCurrentFile()">
                        <i class="fas fa-download"></i> Descargar Archivo
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- CONTENIDO PRINCIPAL (HEADER, DASHBOARD, etc.) -->
    <!-- ... (todo el HTML anterior se mantiene igual) ... -->
    
    <!-- SECCI√ìN MEJORADA DE SUBIDA DE ARCHIVOS -->
    <div class="card">
        <div class="card-header">
            <h2><i class="fas fa-cloud-upload-alt"></i> Gesti√≥n Profesional de Archivos</h2>
            <div class="action-buttons">
                <button class="btn btn-success" onclick="openFileUpload()">
                    <i class="fas fa-cloud-upload-alt"></i> Subir Archivos
                </button>
                <button class="btn btn-primary" onclick="agenda.exportToEmail()">
                    <i class="fas fa-envelope"></i> Enviar por Email
                </button>
                <button class="btn btn-print" onclick="agenda.printProfessionalReport()">
                    <i class="fas fa-print"></i> Imprimir Reporte
                </button>
                <button class="btn btn-secondary" onclick="agenda.downloadAllFiles()">
                    <i class="fas fa-download"></i> Descargar Todo
                </button>
            </div>
        </div>
        
        <!-- √ÅREA DE SUBIDA MEJORADA -->
        <div class="file-upload-system" id="file-drop-area" 
             onclick="document.getElementById('file-input').click()"
             ondragover="handleDragOver(event)"
             ondragleave="handleDragLeave(event)"
             ondrop="handleFileDrop(event)">
            <i class="fas fa-cloud-upload-alt fa-3x" style="margin-bottom: 20px;"></i>
            <h3>Arrastra y suelta archivos aqu√≠</h3>
            <p>o haz clic para seleccionar</p>
            <p class="text-muted">Formatos: JPG, PNG, PDF, DOCX, XLSX, TXT, CSV (M√°x. 25MB)</p>
            <input type="file" id="file-input" multiple style="display: none;" 
                   accept=".jpg,.jpeg,.png,.pdf,.doc,.docx,.xls,.xlsx,.txt,.csv">
        </div>
        
        <!-- PREVISUALIZACI√ìN DE ARCHIVOS -->
        <div id="file-previews" class="file-preview-container">
            <!-- Archivos aparecen aqu√≠ din√°micamente -->
        </div>
        
        <!-- ESTAD√çSTICAS DE ARCHIVOS -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 30px;">
            <div class="stat-item">
                <div class="stat-icon files">
                    <i class="fas fa-database"></i>
                </div>
                <div class="stat-info">
                    <div class="stat-label">Espacio Usado</div>
                    <div class="stat-value" id="storage-used">0 MB</div>
                </div>
            </div>
            <div class="stat-item">
                <div class="stat-icon completed">
                    <i class="fas fa-file-pdf"></i>
                </div>
                <div class="stat-info">
                    <div class="stat-label">Documentos PDF</div>
                    <div class="stat-value" id="pdf-count">0</div>
                </div>
            </div>
            <div class="stat-item">
                <div class="stat-icon meeting">
                    <i class="fas fa-file-image"></i>
                </div>
                <div class="stat-info">
                    <div class="stat-label">Im√°genes</div>
                    <div class="stat-value" id="image-count">0</div>
                </div>
            </div>
            <div class="stat-item">
                <div class="stat-icon pending">
                    <i class="fas fa-file-alt"></i>
                </div>
                <div class="stat-info">
                    <div class="stat-label">Otros Archivos</div>
                    <div class="stat-value" id="other-files-count">0</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- CABECERA PARA IMPRESI√ìN -->
    <div class="print-header print-only">
        <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIwIiBoZWlnaHQ9IjEyMCIgdmlld0JveD0iMCAwIDEyMCAxMjAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxwYXRoIGQ9Ik02MCAxMUMzNy45MSAxMSAyMCAyOC45MSAyMCA1MVMzNy45MSA5MSA2MCA5MSAxMDAgNzMuMDkgMTAwIDUxUzgyLjA5IDExIDYwIDExWk00OC41IDU1LjVMMzcuNSA0NC41TDI1IDU3TDQ4LjUgODAuNUw5NSAzNEw4Mi41IDIxLjVMNDguNSA1NS41WiIgZmlsbD0iIzAwQzZGNSIvPgo8L3N2Zz4K" alt="Logo DRTE" style="height: 60px;">
        <h1>Agenda Digital DRTE - Reporte Oficial</h1>
        <p>Departamento de Investigaci√≥n, Desarrollo e Implementaci√≥n</p>
        <p>Generado: <span id="print-date"></span></p>
    </div>
    
    <script>
        // ============================================
        // SISTEMA COMPLETO DE ARCHIVOS CON INDEXEDDB
        // ============================================
        
        class FileSystemManager {
            constructor() {
                this.db = null;
                this.currentFile = null;
                this.initDatabase();
            }
            
            async initDatabase() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open('AgendaDRTE_Files', 1);
                    
                    request.onerror = () => reject('Error al abrir IndexedDB');
                    request.onsuccess = (event) => {
                        this.db = event.target.result;
                        console.log('‚úÖ IndexedDB para archivos inicializada');
                        this.updateFileStats();
                        resolve();
                    };
                    
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains('files')) {
                            const store = db.createObjectStore('files', { keyPath: 'id' });
                            store.createIndex('type', 'type', { unique: false });
                            store.createIndex('date', 'uploadDate', { unique: false });
                        }
                    };
                });
            }
            
            async uploadFiles(fileList) {
                try {
                    const uploadedFiles = [];
                    
                    for (const file of fileList) {
                        if (file.size > 25 * 1024 * 1024) {
                            throw new Error(`El archivo ${file.name} excede 25MB`);
                        }
                        
                        const fileData = {
                            id: Date.now() + '-' + Math.random().toString(36).substr(2, 9),
                            name: file.name,
                            type: file.type,
                            size: file.size,
                            uploadDate: new Date().toISOString(),
                            data: await this.readFileAsArrayBuffer(file)
                        };
                        
                        await this.saveFileToDB(fileData);
                        uploadedFiles.push(fileData);
                        
                        // Mostrar previsualizaci√≥n inmediata
                        this.addFilePreview(fileData);
                    }
                    
                    this.updateFileStats();
                    agenda.showNotification(
                        'Archivos subidos',
                        `${uploadedFiles.length} archivo(s) subido(s) exitosamente`,
                        'success'
                    );
                    
                    return uploadedFiles;
                    
                } catch (error) {
                    agenda.showNotification('Error', error.message, 'error');
                    throw error;
                }
            }
            
            readFileAsArrayBuffer(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = (e) => reject(e);
                    reader.readAsArrayBuffer(file);
                });
            }
            
            async saveFileToDB(fileData) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['files'], 'readwrite');
                    const store = transaction.objectStore('files');
                    const request = store.put(fileData);
                    
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject('Error al guardar archivo');
                });
            }
            
            addFilePreview(fileData) {
                const container = document.getElementById('file-previews');
                const preview = document.createElement('div');
                preview.className = 'file-preview';
                preview.dataset.fileId = fileData.id;
                
                let previewContent = '';
                
                if (fileData.type.startsWith('image/')) {
                    const blob = new Blob([fileData.data], { type: fileData.type });
                    const url = URL.createObjectURL(blob);
                    previewContent = `<img src="${url}" alt="${fileData.name}" onclick="fileSystem.previewFile('${fileData.id}')">`;
                } else if (fileData.type === 'application/pdf') {
                    previewContent = `
                        <i class="fas fa-file-pdf fa-3x" style="color: #ea4335;"></i>
                        <div style="text-align: center;">
                            <strong>${fileData.name}</strong>
                            <p style="font-size: 0.8rem; opacity: 0.8;">PDF - ${this.formatFileSize(fileData.size)}</p>
                        </div>
                    `;
                } else if (fileData.type.includes('word') || fileData.name.endsWith('.docx') || fileData.name.endsWith('.doc')) {
                    previewContent = `
                        <i class="fas fa-file-word fa-3x" style="color: #2b579a;"></i>
                        <div style="text-align: center;">
                            <strong>${fileData.name}</strong>
                            <p style="font-size: 0.8rem; opacity: 0.8;">Documento - ${this.formatFileSize(fileData.size)}</p>
                        </div>
                    `;
                } else if (fileData.type.includes('excel') || fileData.name.endsWith('.xlsx') || fileData.name.endsWith('.xls')) {
                    previewContent = `
                        <i class="fas fa-file-excel fa-3x" style="color: #217346;"></i>
                        <div style="text-align: center;">
                            <strong>${fileData.name}</strong>
                            <p style="font-size: 0.8rem; opacity: 0.8;">Excel - ${this.formatFileSize(fileData.size)}</p>
                        </div>
                    `;
                } else {
                    previewContent = `
                        <i class="fas fa-file fa-3x"></i>
                        <div style="text-align: center;">
                            <strong>${fileData.name}</strong>
                            <p style="font-size: 0.8rem; opacity: 0.8;">${fileData.type} - ${this.formatFileSize(fileData.size)}</p>
                        </div>
                    `;
                }
                
                preview.innerHTML = previewContent + `
                    <div class="file-actions">
                        <button class="btn btn-sm btn-primary" onclick="fileSystem.previewFile('${fileData.id}')">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-success" onclick="fileSystem.downloadFile('${fileData.id}')">
                            <i class="fas fa-download"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="fileSystem.deleteFile('${fileData.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                
                container.appendChild(preview);
            }
            
            async previewFile(fileId) {
                try {
                    const fileData = await this.getFileFromDB(fileId);
                    if (!fileData) {
                        throw new Error('Archivo no encontrado');
                    }
                    
                    this.currentFile = fileData;
                    const modal = document.getElementById('file-viewer-modal');
                    const title = document.getElementById('viewer-title');
                    const pdfViewer = document.getElementById('pdf-viewer');
                    const imageViewer = document.getElementById('image-viewer');
                    const textViewer = document.getElementById('text-viewer');
                    const otherViewer = document.getElementById('other-file-viewer');
                    
                    // Ocultar todos los visores
                    [pdfViewer, imageViewer, textViewer, otherViewer].forEach(v => v.style.display = 'none');
                    
                    // Configurar t√≠tulo
                    title.textContent = `Vista previa: ${fileData.name}`;
                    
                    // Crear blob para visualizaci√≥n
                    const blob = new Blob([fileData.data], { type: fileData.type });
                    const url = URL.createObjectURL(blob);
                    
                    // Mostrar seg√∫n tipo de archivo
                    if (fileData.type.startsWith('image/')) {
                        imageViewer.src = url;
                        imageViewer.style.display = 'block';
                        imageViewer.alt = fileData.name;
                    } else if (fileData.type === 'application/pdf') {
                        pdfViewer.src = url + '#view=FitH';
                        pdfViewer.style.display = 'block';
                    } else if (fileData.type.startsWith('text/')) {
                        const text = await blob.text();
                        textViewer.textContent = text;
                        textViewer.style.display = 'block';
                    } else {
                        otherViewer.style.display = 'block';
                    }
                    
                    modal.classList.add('active');
                    document.body.style.overflow = 'hidden';
                    
                } catch (error) {
                    agenda.showNotification('Error', 'No se pudo previsualizar el archivo', 'error');
                }
            }
            
            async downloadFile(fileId) {
                try {
                    const fileData = await this.getFileFromDB(fileId);
                    if (!fileData) {
                        throw new Error('Archivo no encontrado');
                    }
                    
                    const blob = new Blob([fileData.data], { type: fileData.type });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = fileData.name;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    agenda.showNotification('Descarga iniciada', `Descargando ${fileData.name}`, 'success');
                    
                } catch (error) {
                    agenda.showNotification('Error', 'No se pudo descargar el archivo', 'error');
                }
            }
            
            async deleteFile(fileId) {
                if (!confirm('¬øEst√° seguro de eliminar este archivo?')) return;
                
                try {
                    const transaction = this.db.transaction(['files'], 'readwrite');
                    const store = transaction.objectStore('files');
                    await store.delete(fileId);
                    
                    // Eliminar previsualizaci√≥n
                    const preview = document.querySelector(`[data-file-id="${fileId}"]`);
                    if (preview) preview.remove();
                    
                    this.updateFileStats();
                    agenda.showNotification('Archivo eliminado', 'El archivo ha sido eliminado', 'success');
                    
                } catch (error) {
                    agenda.showNotification('Error', 'No se pudo eliminar el archivo', 'error');
                }
            }
            
            async downloadAllFiles() {
                try {
                    const files = await this.getAllFiles();
                    if (files.length === 0) {
                        agenda.showNotification('Info', 'No hay archivos para descargar', 'info');
                        return;
                    }
                    
                    // Crear archivo ZIP (simplificado - en producci√≥n usar JSZip)
                    if (files.length === 1) {
                        this.downloadFile(files[0].id);
                    } else {
                        agenda.showNotification('Descarga m√∫ltiple', 
                            `Iniciando descarga de ${files.length} archivos`, 'info');
                        
                        // Descargar archivos uno por uno
                        for (const file of files) {
                            await this.downloadFile(file.id);
                            await new Promise(resolve => setTimeout(resolve, 500)); // Pausa entre descargas
                        }
                    }
                    
                } catch (error) {
                    agenda.showNotification('Error', 'Error en descarga m√∫ltiple', 'error');
                }
            }
            
            async getFileFromDB(fileId) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['files'], 'readonly');
                    const store = transaction.objectStore('files');
                    const request = store.get(fileId);
                    
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject('Error al obtener archivo');
                });
            }
            
            async getAllFiles() {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['files'], 'readonly');
                    const store = transaction.objectStore('files');
                    const request = store.getAll();
                    
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject('Error al obtener archivos');
                });
            }
            
            async updateFileStats() {
                try {
                    const files = await this.getAllFiles();
                    
                    // Calcular estad√≠sticas
                    const totalSize = files.reduce((sum, file) => sum + file.size, 0);
                    const pdfCount = files.filter(f => f.type === 'application/pdf').length;
                    const imageCount = files.filter(f => f.type.startsWith('image/')).length;
                    const otherCount = files.length - pdfCount - imageCount;
                    
                    // Actualizar UI
                    document.getElementById('total-files').textContent = files.length;
                    document.getElementById('storage-used').textContent = this.formatFileSize(totalSize);
                    document.getElementById('pdf-count').textContent = pdfCount;
                    document.getElementById('image-count').textContent = imageCount;
                    document.getElementById('other-files-count').textContent = otherCount;
                    
                } catch (error) {
                    console.error('Error actualizando estad√≠sticas:', error);
                }
            }
            
            formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }
        }
        
        // ============================================
        // FUNCIONES MEJORADAS PARA LA AGENDA
        // ============================================
        
        class EnhancedAgendaDRTE extends AgendaDRTE {
            constructor() {
                super();
                this.fileSystem = new FileSystemManager();
                this.initEnhancedFeatures();
            }
            
            initEnhancedFeatures() {
                // Inicializar arrastrar y soltar
                this.setupDragAndDrop();
                
                // Configurar fecha de impresi√≥n
                document.getElementById('print-date').textContent = 
                    new Date().toLocaleDateString('es-CR', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
            }
            
            setupDragAndDrop() {
                const dropArea = document.getElementById('file-drop-area');
                
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    dropArea.addEventListener(eventName, this.preventDefaults, false);
                });
                
                function handleDragOver(e) {
                    dropArea.classList.add('dragover');
                }
                
                function handleDragLeave(e) {
                    if (!dropArea.contains(e.relatedTarget)) {
                        dropArea.classList.remove('dragover');
                    }
                }
                
                async function handleFileDrop(e) {
                    dropArea.classList.remove('dragover');
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        await this.fileSystem.uploadFiles(files);
                    }
                }
                
                dropArea.addEventListener('dragover', handleDragOver);
                dropArea.addEventListener('dragleave', handleDragLeave);
                dropArea.addEventListener('drop', handleFileDrop.bind(this));
            }
            
            preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            // ============================================
            // SISTEMA DE IMPRESI√ìN PROFESIONAL
            // ============================================
            
            printProfessionalReport() {
                try {
                    // Guardar contenido actual
                    const originalTitle = document.title;
                    
                    // Configurar para impresi√≥n
                    document.title = 'Agenda DRTE - Reporte Oficial';
                    
                    // Mostrar solo elementos relevantes para imprimir
                    const elementsToPrint = document.querySelectorAll('.card, .print-header');
                    
                    // Ocultar elementos no deseados
                    document.querySelectorAll('.no-print, .external-links-panel, .btn').forEach(el => {
                        el.style.display = 'none';
                    });
                    
                    // Mostrar cabecera de impresi√≥n
                    document.querySelector('.print-header').style.display = 'block';
                    
                    // Imprimir
                    window.print();
                    
                    // Restaurar estado original
                    setTimeout(() => {
                        document.title = originalTitle;
                        document.querySelectorAll('.no-print, .external-links-panel, .btn').forEach(el => {
                            el.style.display = '';
                        });
                        document.querySelector('.print-header').style.display = 'none';
                    }, 1000);
                    
                    this.showNotification('Impresi√≥n', 'Reporte listo para imprimir', 'success');
                    
                } catch (error) {
                    console.error('Error en impresi√≥n:', error);
                    this.showNotification('Error', 'No se pudo preparar la impresi√≥n', 'error');
                }
            }
            
            // ============================================
            // SISTEMA DE CORREO ELECTR√ìNICO PROFESIONAL
            // ============================================
            
            exportToEmail() {
                try {
                    const tasks = this.getTasks();
                    const files = this.fileSystem.getAllFiles ? this.fileSystem.getAllFiles() : [];
                    
                    // Crear contenido del email
                    const subject = encodeURIComponent(`Reporte Agenda DRTE - ${this.formatDate(new Date())}`);
                    
                    let body = `Reporte generado desde Agenda Digital DRTE\n\n`;
                    body += `Fecha: ${new Date().toLocaleDateString('es-CR')}\n`;
                    body += `Total de tareas: ${tasks.length}\n`;
                    body += `Tareas completadas: ${tasks.filter(t => t.status === 'completed').length}\n\n`;
                    
                    body += `RESUMEN DE TAREAS:\n`;
                    body += `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n`;
                    
                    tasks.forEach((task, index) => {
                        body += `${index + 1}. ${task.title}\n`;
                        body += `   üìÖ ${task.date} | üìç ${this.getCategoryLabel(task.category)} | ${this.getPriorityBadge(task.priority)}\n`;
                        if (task.description) {
                            body += `   üìù ${task.description.substring(0, 100)}${task.description.length > 100 ? '...' : ''}\n`;
                        }
                        body += `\n`;
                    });
                    
                    body += `\nARCHIVOS ADJUNTOS (${files.length}):\n`;
                    body += `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n`;
                    
                    files.forEach(file => {
                        body += `‚Ä¢ ${file.name} (${this.fileSystem.formatFileSize(file.size)})\n`;
                    });
                    
                    body += `\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n`;
                    body += `Generado autom√°ticamente por Agenda Digital DRTE\n`;
                    body += `Departamento de Investigaci√≥n, Desarrollo e Implementaci√≥n`;
                    
                    // Crear enlace mailto
                    const mailtoLink = `mailto:?subject=${subject}&body=${encodeURIComponent(body)}`;
                    
                    // Abrir cliente de correo
                    window.open(mailtoLink, '_blank');
                    
                    this.showNotification('Correo listo', 'Cliente de correo abierto con el reporte', 'success');
                    
                } catch (error) {
                    console.error('Error en exportaci√≥n a email:', error);
                    this.showNotification('Error', 'No se pudo preparar el correo', 'error');
                }
            }
            
            // ============================================
            // FUNCIONES P√öBLICAS MEJORADAS
            // ============================================
            
            openFileUpload() {
                document.getElementById('file-input').click();
            }
            
            async handleFileSelect(event) {
                const files = event.target.files;
                if (files.length > 0) {
                    await this.fileSystem.uploadFiles(files);
                    event.target.value = ''; // Reset input
                }
            }
        }
        
        // ============================================
        // INICIALIZACI√ìN GLOBAL MEJORADA
        // ============================================
        
        let agenda;
        let fileSystem;
        
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Crear instancia mejorada
                agenda = new EnhancedAgendaDRTE();
                fileSystem = agenda.fileSystem;
                
                // Configurar eventos de archivos
                document.getElementById('file-input').addEventListener('change', (e) => {
                    agenda.handleFileSelect(e);
                });
                
                // Hacer globales
                window.agenda = agenda;
                window.fileSystem = fileSystem;
                
                // Configurar funciones globales
                window.handleDragOver = function(e) {
                    e.preventDefault();
                    document.getElementById('file-drop-area').classList.add('dragover');
                };
                
                window.handleDragLeave = function(e) {
                    e.preventDefault();
                    if (!document.getElementById('file-drop-area').contains(e.relatedTarget)) {
                        document.getElementById('file-drop-area').classList.remove('dragover');
                    }
                };
                
                window.handleFileDrop = async function(e) {
                    e.preventDefault();
                    document.getElementById('file-drop-area').classList.remove('dragover');
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        await fileSystem.uploadFiles(files);
                    }
                };
                
                window.closeViewer = function() {
                    document.getElementById('file-viewer-modal').classList.remove('active');
                    document.body.style.overflow = 'auto';
                    
                    // Liberar URLs de objetos
                    const viewers = ['pdf-viewer', 'image-viewer'];
                    viewers.forEach(id => {
                        const element = document.getElementById(id);
                        if (element.src) {
                            URL.revokeObjectURL(element.src);
                            element.src = '';
                        }
                    });
                };
                
                window.downloadCurrentFile = function() {
                    if (fileSystem.currentFile) {
                        fileSystem.downloadFile(fileSystem.currentFile.id);
                    }
                };
                
                console.log('üöÄ Sistema Agenda DRTE MEJORADO inicializado');
                
            } catch (error) {
                console.error('‚ùå Error cr√≠tico:', error);
                alert('Error al cargar la aplicaci√≥n. Por favor, recarga la p√°gina.');
            }
        });
        
        // Funciones globales mejoradas
        function openFileUpload() { agenda.openFileUpload(); }
        function closeViewer() { 
            document.getElementById('file-viewer-modal').classList.remove('active');
            document.body.style.overflow = 'auto';
        }
    </script>
</body>
</html>
