<!DOCTYPE html>
<html lang="es-CR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Agenda Digital DRTE - Sistema Integral de Gesti√≥n">
    <meta name="theme-color" content="#1a1a2e">
    <title>Agenda Digital DRTE | Sistema Profesional</title>
    
    <!-- ENLACES EXTERNOS DRTE -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/viewerjs/1.11.6/viewer.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/viewerjs/1.11.6/viewer.min.js"></script>
    
    <style>
        /* ===== ESTILOS PROFESIONALES COMPLETOS ===== */
        :root {
            --color-primary: #1a1a2e; --color-secondary: #16213e; --color-accent: #0f3460;
            --color-success: #00b894; --color-warning: #fdcb6e; --color-danger: #d63031;
            --color-info: #0984e3; --color-light: #f8f9fa; --color-dark: #2d3436;
            --border-radius: 12px; --box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            --transition: all 0.3s ease; --glass-bg: rgba(255,255,255,0.05);
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-secondary) 100%);
            color: var(--color-light);
            min-height: 100vh;
            line-height: 1.6;
        }
        
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }

        /* ===== HEADER CORPORATIVO ===== */
        .header {
            background: rgba(255,255,255,0.08); backdrop-filter: blur(20px); border-radius: var(--border-radius);
            padding: 20px 30px; margin-bottom: 30px; border: 1px solid rgba(255,255,255,0.1);
            display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;
            box-shadow: var(--box-shadow);
        }
        
        .brand {
            display: flex; align-items: center; gap: 20px;
        }
        
        .logo {
            width: 60px; height: 60px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: var(--border-radius); display: flex; align-items: center; justify-content: center;
            font-size: 28px; color: white; box-shadow: 0 5px 15px rgba(102,126,234,0.4);
        }
        
        .brand-info h1 { font-size: 1.8rem; font-weight: 700; margin-bottom: 5px; }
        .brand-info p { color: rgba(255,255,255,0.7); font-size: 0.9rem; }
        
        .header-controls { display: flex; gap: 15px; align-items: center; }
        
        .status-badge {
            background: rgba(0,184,148,0.2); color: var(--color-success); padding: 8px 15px;
            border-radius: 20px; font-size: 0.85rem; font-weight: 500; display: flex; align-items: center; gap: 8px;
        }
        
        .datetime { font-size: 0.9rem; color: rgba(255,255,255,0.7); }

        /* ===== BOTONES PROFESIONALES ===== */
        .btn {
            padding: 12px 24px; border: none; border-radius: var(--border-radius); font-weight: 600;
            cursor: pointer; transition: var(--transition); display: inline-flex; align-items: center; gap: 10px;
            font-size: 0.95rem; text-decoration: none; user-select: none;
        }
        
        .btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.2); }
        
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-secondary { background: var(--glass-bg); color: white; border: 1px solid rgba(255,255,255,0.2); }
        .btn-success { background: var(--color-success); color: white; }
        .btn-danger { background: var(--color-danger); color: white; }
        
        .btn-email { background: linear-gradient(135deg, #ea4335 0%, #d14836 100%); color: white; }
        .btn-print { background: linear-gradient(135deg, #4285f4 0%, #3367d6 100%); color: white; }
        
        .btn-export { position: relative; }
        .export-dropdown {
            position: absolute; top: 100%; right: 0; background: var(--color-secondary); border-radius: var(--border-radius);
            padding: 10px; min-width: 200px; margin-top: 10px; display: none; z-index: 1000;
            border: 1px solid rgba(255,255,255,0.1); box-shadow: var(--box-shadow);
        }
        
        .btn-export:hover .export-dropdown { display: block; }
        .export-dropdown a {
            display: block; padding: 10px 15px; color: white; text-decoration: none; border-radius: 8px;
            transition: var(--transition); font-size: 0.9rem;
        }
        
        .export-dropdown a:hover { background: rgba(255,255,255,0.1); }

        /* ===== PANEL DE ENLACES EXTERNOS DRTE ===== */
        .external-links-panel {
            background: rgba(0,0,0,0.3);
            padding: 15px 30px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            gap: 25px;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 20px;
        }
        
        .external-link {
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            padding: 8px 15px;
            border-radius: 20px;
            transition: var(--transition);
            background: rgba(255,255,255,0.05);
        }
        
        .external-link:hover {
            background: rgba(255,255,255,0.1);
            color: white;
            transform: translateY(-2px);
        }

        /* ===== PANEL PRINCIPAL ===== */
        .dashboard-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 25px; margin-bottom: 30px;
        }
        
        .card {
            background: rgba(255,255,255,0.08); backdrop-filter: blur(20px); border-radius: var(--border-radius);
            padding: 25px; border: 1px solid rgba(255,255,255,0.1); box-shadow: var(--box-shadow);
        }
        
        .card-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;
        }
        
        .card-header h2 { font-size: 1.3rem; font-weight: 600; display: flex; align-items: center; gap: 10px; }
        
        .card-badge {
            background: rgba(253,203,110,0.2); color: var(--color-warning); padding: 5px 12px;
            border-radius: 15px; font-size: 0.8rem; font-weight: 500;
        }

        /* ===== ESTAD√çSTICAS ===== */
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        
        .stat-item {
            background: var(--glass-bg); padding: 15px; border-radius: var(--border-radius);
            display: flex; align-items: center; gap: 15px;
        }
        
        .stat-icon {
            width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center;
            font-size: 20px;
        }
        
        .stat-icon.pending { background: rgba(253,203,110,0.2); color: var(--color-warning); }
        .stat-icon.completed { background: rgba(0,184,148,0.2); color: var(--color-success); }
        .stat-icon.meeting { background: rgba(9,132,227,0.2); color: var(--color-info); }
        .stat-icon.files { background: rgba(155,89,182,0.2); color: #9b59b6; }
        
        .stat-info { flex: 1; }
        .stat-label { font-size: 0.85rem; color: rgba(255,255,255,0.7); margin-bottom: 3px; }
        .stat-value { font-size: 1.5rem; font-weight: 700; }

        /* ===== CALENDARIO ===== */
        .calendar { margin-bottom: 30px; }
        
        .calendar-nav {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;
        }
        
        .calendar-nav h2 { font-size: 1.5rem; font-weight: 600; }
        
        .calendar-days {
            display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin-bottom: 15px;
        }
        
        .calendar-weekday {
            text-align: center; font-weight: 600; padding: 10px; color: rgba(255,255,255,0.7);
            font-size: 0.9rem;
        }
        
        .calendar-day {
            aspect-ratio: 1; background: var(--glass-bg); border-radius: 10px; display: flex;
            align-items: center; justify-content: center; cursor: pointer; transition: var(--transition);
            border: 2px solid transparent;
        }
        
        .calendar-day:hover { background: rgba(255,255,255,0.15); }
        .calendar-day.today { background: rgba(102,126,234,0.3); border-color: #667eea; }
        
        .calendar-day.has-event { position: relative; }
        .calendar-day.has-event::after {
            content: ''; position: absolute; bottom: 8px; width: 6px; height: 6px;
            background: var(--color-success); border-radius: 50%;
        }

        /* ===== FORMULARIO ===== */
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 500; }
        
        .form-control {
            width: 100%; padding: 14px 18px; background: rgba(255,255,255,0.07); border: 1px solid rgba(255,255,255,0.1);
            border-radius: var(--border-radius); color: white; font-size: 1rem; transition: var(--transition);
        }
        
        .form-control:focus {
            outline: none; border-color: #667eea; background: rgba(255,255,255,0.1);
            box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
        }
        
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        textarea.form-control { min-height: 120px; resize: vertical; }

        /* ===== SISTEMA DE SUBIDA DE ARCHIVOS MEJORADO ===== */
        .file-upload-system {
            border: 2px dashed rgba(255,255,255,0.3);
            border-radius: var(--border-radius);
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            background: rgba(255,255,255,0.02);
            margin: 20px 0;
        }
        
        .file-upload-system.dragover {
            border-color: var(--color-success);
            background: rgba(0,184,148,0.1);
            transform: scale(1.02);
        }
        
        .file-preview-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .file-preview {
            background: rgba(255,255,255,0.08);
            border-radius: var(--border-radius);
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            transition: var(--transition);
            position: relative;
        }
        
        .file-preview:hover {
            background: rgba(255,255,255,0.12);
            transform: translateY(-5px);
        }
        
        .file-preview img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
        }
        
        .file-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        /* ===== LISTA DE TAREAS ===== */
        .task-filters {
            display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 10px 20px; background: var(--glass-bg); color: white; border: 1px solid rgba(255,255,255,0.1);
            border-radius: 20px; cursor: pointer; transition: var(--transition); font-size: 0.9rem;
        }
        
        .filter-btn.active { background: #667eea; border-color: #667eea; }
        
        .tasks-container { min-height: 400px; }
        .task-list { display: flex; flex-direction: column; gap: 15px; }
        
        .task-item {
            background: rgba(255,255,255,0.08); border-radius: var(--border-radius); padding: 20px;
            border-left: 4px solid transparent; transition: var(--transition);
        }
        
        .task-item:hover { background: rgba(255,255,255,0.12); transform: translateX(5px); }
        .task-item.pending { border-left-color: var(--color-warning); }
        .task-item.completed { border-left-color: var(--color-success); opacity: 0.8; }
        .task-item.urgent { border-left-color: var(--color-danger); }
        
        .task-header {
            display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;
        }
        
        .task-title { font-size: 1.1rem; font-weight: 600; flex: 1; }
        .task-actions { display: flex; gap: 10px; }
        
        .task-action-btn {
            width: 32px; height: 32px; border-radius: 8px; background: rgba(255,255,255,0.1);
            border: none; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: var(--transition);
        }
        
        .task-action-btn:hover { background: rgba(255,255,255,0.2); }
        
        .task-meta {
            display: flex; gap: 15px; margin-top: 10px; flex-wrap: wrap;
        }
        
        .task-meta-item {
            display: flex; align-items: center; gap: 5px; font-size: 0.85rem; color: rgba(255,255,255,0.7);
        }

        /* ===== VISOR DE ARCHIVOS PROFESIONAL ===== */
        #file-viewer-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
        }
        
        #file-viewer-modal.active {
            display: flex;
        }
        
        .file-viewer-content {
            width: 90%;
            height: 90%;
            background: var(--color-primary);
            border-radius: var(--border-radius);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .file-viewer-header {
            padding: 20px;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .file-viewer-body {
            flex: 1;
            padding: 20px;
            overflow: auto;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #pdf-viewer {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        #image-viewer {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        /* ===== SISTEMA DE IMPRESI√ìN PROFESIONAL ===== */
        @media print {
            .no-print {
                display: none !important;
            }
            
            .print-only {
                display: block !important;
            }
            
            body {
                background: white !important;
                color: black !important;
            }
            
            .card {
                box-shadow: none !important;
                border: 1px solid #ddd !important;
                background: white !important;
                color: black !important;
            }
        }
        
        .print-header {
            display: none;
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #000;
        }

        /* ===== MODALES ===== */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8);
            display: none; align-items: center; justify-content: center; z-index: 9999;
            backdrop-filter: blur(5px);
        }
        
        .modal-overlay.active { display: flex; }
        
        .modal {
            background: var(--color-primary); border-radius: var(--border-radius); padding: 30px;
            max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto;
            border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 25px 50px rgba(0,0,0,0.3);
            animation: modalSlideIn 0.3s ease;
        }
        
        @keyframes modalSlideIn {
            from { opacity: 0; transform: translateY(-30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .modal-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;
        }
        
        .modal-close {
            width: 36px; height: 36px; border-radius: 50%; background: rgba(255,255,255,0.1);
            border: none; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: var(--transition);
        }
        
        .modal-close:hover { background: rgba(255,255,255,0.2); }

        /* ===== NOTIFICACIONES ===== */
        .notification-center {
            position: fixed; bottom: 20px; right: 20px; z-index: 9998; display: flex; flex-direction: column; gap: 10px;
        }
        
        .notification {
            background: var(--color-secondary); border-radius: var(--border-radius); padding: 15px 20px;
            border-left: 4px solid; box-shadow: var(--box-shadow); min-width: 300px; animation: slideInRight 0.3s ease;
            display: flex; justify-content: space-between; align-items: center;
        }
        
        .notification.success { border-left-color: var(--color-success); }
        .notification.error { border-left-color: var(--color-danger); }
        .notification.info { border-left-color: var(--color-info); }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 768px) {
            .header { flex-direction: column; gap: 20px; text-align: center; }
            .brand { justify-content: center; }
            .form-row { grid-template-columns: 1fr; }
            .dashboard-grid { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: 1fr; }
            .calendar-days { grid-template-columns: repeat(7, 1fr); gap: 5px; }
            .calendar-day { font-size: 0.9rem; }
            .external-links-panel { gap: 10px; padding: 10px; }
        }

        /* ===== ESTADOS DE VAC√çO ===== */
        .empty-state {
            text-align: center; padding: 50px 20px; color: rgba(255,255,255,0.5);
        }
        
        .empty-icon { font-size: 48px; margin-bottom: 20px; opacity: 0.5; }
        
        .text-muted { color: rgba(255,255,255,0.5); font-size: 0.9rem; }
        .mt-3 { margin-top: 15px; }
        .mb-3 { margin-bottom: 15px; }
        .btn-block { width: 100%; }
        .btn-sm { padding: 8px 16px; font-size: 0.85rem; }
    </style>
</head>
<body>
    <!-- SISTEMA DE NOTIFICACIONES -->
    <div id="notification-center" class="notification-center"></div>

    <!-- PANEL DE ENLACES EXTERNOS DRTE -->
    <div class="external-links-panel no-print">
        <a href="https://www.mep.go.cr/" class="external-link" target="_blank">
            <i class="fas fa-school"></i> MEP Oficial
        </a>
        <a href="https://www.drte.mep.go.cr/" class="external-link" target="_blank">
            <i class="fas fa-chalkboard-teacher"></i> DRTE Portal
        </a>
        <a href="https://drive.google.com/" class="external-link" target="_blank">
            <i class="fab fa-google-drive"></i> Google Drive
        </a>
        <a href="https://outlook.office.com/" class="external-link" target="_blank">
            <i class="fas fa-envelope"></i> Correo Institucional
        </a>
        <a href="https://teams.microsoft.com/" class="external-link" target="_blank">
            <i class="fas fa-video"></i> Microsoft Teams
        </a>
        <a href="https://meet.google.com/" class="external-link" target="_blank">
            <i class="fab fa-google"></i> Google Meet
        </a>
        <a href="https://trello.com/" class="external-link" target="_blank">
            <i class="fab fa-trello"></i> Trello
        </a>
        <a href="https://calendar.google.com/" class="external-link" target="_blank">
            <i class="fas fa-calendar"></i> Calendario
        </a>
    </div>

    <!-- VISOR DE ARCHIVOS PROFESIONAL -->
    <div id="file-viewer-modal">
        <div class="file-viewer-content">
            <div class="file-viewer-header">
                <h3 id="viewer-title">Visualizando Archivo</h3>
                <button class="btn btn-danger" onclick="closeViewer()">
                    <i class="fas fa-times"></i> Cerrar
                </button>
            </div>
            <div class="file-viewer-body">
                <iframe id="pdf-viewer" style="display: none;"></iframe>
                <img id="image-viewer" style="display: none;" alt="Vista previa de imagen">
                <div id="text-viewer" style="display: none; white-space: pre-wrap; font-family: monospace;"></div>
                <div id="other-file-viewer" style="display: none;">
                    <i class="fas fa-file fa-5x"></i>
                    <p>Este tipo de archivo no tiene vista previa disponible</p>
                    <button class="btn btn-primary" onclick="downloadCurrentFile()">
                        <i class="fas fa-download"></i> Descargar Archivo
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODALES -->
    <div id="task-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2><i class="fas fa-tasks"></i> Nueva Tarea</h2>
                <button class="modal-close" onclick="closeModal('task-modal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="task-form" onsubmit="saveTask(event)">
                <div class="form-group">
                    <label class="form-label">T√≠tulo de la Tarea</label>
                    <input type="text" id="task-title" class="form-control" required placeholder="Ej: Revisi√≥n de informes trimestrales">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Fecha</label>
                        <input type="date" id="task-date" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Prioridad</label>
                        <select id="task-priority" class="form-control" required>
                            <option value="">Seleccionar prioridad</option>
                            <option value="low">üü¢ Baja</option>
                            <option value="medium">üü° Media</option>
                            <option value="high">üü† Alta</option>
                            <option value="urgent">üî¥ Urgente</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Categor√≠a</label>
                        <select id="task-category" class="form-control" required>
                            <option value="">Seleccionar categor√≠a</option>
                            <option value="pntf">üìä PNFT - Actividades Principales</option>
                            <option value="meeting">üë• Reuniones & Coordinaciones</option>
                            <option value="training">üéì Capacitaci√≥n & Talleres</option>
                            <option value="design">üé® Dise√±o Instruccional</option>
                            <option value="report">üìÑ Informes & Documentaci√≥n</option>
                            <option value="system">üíª Sistemas & Actualizaci√≥n</option>
                            <option value="other">üìã Otras Tareas</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Estado</label>
                        <select id="task-status" class="form-control" required>
                            <option value="pending">‚è≥ Pendiente</option>
                            <option value="in-progress">üîÑ En Progreso</option>
                            <option value="completed">‚úÖ Completado</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Descripci√≥n Detallada</label>
                    <textarea id="task-description" class="form-control" rows="4" placeholder="Describe los detalles, objetivos y consideraciones importantes de esta tarea..."></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Etiquetas (separadas por comas)</label>
                    <input type="text" id="task-tags" class="form-control" placeholder="Ej: informe, trimestre, revisi√≥n, gerencia">
                </div>

                <div class="form-group">
                    <label class="form-label">Ubicaci√≥n / Enlace</label>
                    <input type="text" id="task-location" class="form-control" placeholder="Ej: Sala de juntas 3 o https://meet.google.com/xxx">
                </div>

                <div class="form-group">
                    <label class="form-label">Archivos Adjuntos</label>
                    <div class="file-upload-system" onclick="document.getElementById('task-files').click()">
                        <i class="fas fa-cloud-upload-alt fa-2x"></i>
                        <p>Arrastra archivos aqu√≠ o haz clic para subir</p>
                        <p class="text-muted">Formatos: JPG, PNG, PDF, DOCX, XLSX (M√°x. 10MB)</p>
                        <input type="file" id="task-files" multiple style="display: none">
                    </div>
                    <div id="file-preview" class="mt-3"></div>
                </div>

                <div class="form-group">
                    <button type="submit" class="btn btn-primary btn-block">
                        <i class="fas fa-save"></i> Guardar Tarea
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="export-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2><i class="fas fa-file-export"></i> Exportar Datos</h2>
                <button class="modal-close" onclick="closeModal('export-modal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div style="padding: 20px 0;">
                <button class="btn btn-primary btn-block mb-3" onclick="exportToExcel()">
                    <i class="fas fa-file-excel"></i> Exportar a Excel
                </button>
                <button class="btn btn-danger btn-block mb-3" onclick="exportToPDF()">
                    <i class="fas fa-file-pdf"></i> Exportar a PDF
                </button>
                <button class="btn btn-success btn-block" onclick="exportToCSV()">
                    <i class="fas fa-file-csv"></i> Exportar a CSV
                </button>
            </div>
        </div>
    </div>

    <!-- CONTENIDO PRINCIPAL -->
    <div class="container">
        <!-- HEADER CORPORATIVO -->
        <header class="header">
            <div class="brand">
                <div class="logo">
                    <i class="fas fa-chalkboard-teacher"></i>
                </div>
                <div class="brand-info">
                    <h1>Agenda Digital DRTE</h1>
                    <p>Sistema Profesional de Gesti√≥n Integral</p>
                    <p style="font-size: 0.8rem; margin-top: 5px;">
                        <i class="fas fa-user-tie"></i> Asesor Nacional | 
                        <i class="fas fa-building"></i> Departamento de Investigaci√≥n, Desarrollo e Implementaci√≥n
                    </p>
                </div>
            </div>
            <div class="header-controls">
                <div class="status-badge">
                    <i class="fas fa-check-circle"></i> Sistema 100% Operativo
                </div>
                <div class="datetime" id="current-datetime">
                    <i class="fas fa-clock"></i> Cargando fecha...
                </div>
                <button class="btn btn-export" onclick="showExportModal()">
                    <i class="fas fa-file-export"></i> Exportar
                    <div class="export-dropdown">
                        <a onclick="exportToExcel()"><i class="fas fa-file-excel"></i> Excel</a>
                        <a onclick="exportToPDF()"><i class="fas fa-file-pdf"></i> PDF</a>
                        <a onclick="exportToCSV()"><i class="fas fa-file-csv"></i> CSV</a>
                        <a onclick="exportBackup()"><i class="fas fa-database"></i> Backup</a>
                    </div>
                </button>
                <button class="btn btn-secondary" onclick="openBackupManager()">
                    <i class="fas fa-shield-alt"></i> Backup
                </button>
            </div>
        </header>

        <!-- DASHBOARD PRINCIPAL -->
        <div class="dashboard-grid">
            <!-- RESUMEN DEL D√çA -->
            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-chart-line"></i> Resumen del D√≠a</h2>
                    <span class="card-badge" id="today-badge">HOY</span>
                </div>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-icon pending">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-label">Tareas Pendientes</div>
                            <div class="stat-value" id="today-pending">0</div>
                        </div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-icon completed">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-label">Completadas Hoy</div>
                            <div class="stat-value" id="today-completed">0</div>
                        </div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-icon meeting">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-label">Reuniones</div>
                            <div class="stat-value" id="today-meetings">0</div>
                        </div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-icon files">
                            <i class="fas fa-file"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-label">Archivos</div>
                            <div class="stat-value" id="total-files">0</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ACCIONES R√ÅPIDAS -->
            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-bolt"></i> Acciones R√°pidas</h2>
                </div>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                    <button class="btn btn-primary" onclick="openTaskModal()">
                        <i class="fas fa-plus-circle"></i> Nueva Tarea
                    </button>
                    <button class="btn btn-secondary" onclick="quickMeeting()">
                        <i class="fas fa-users"></i> Agendar Reuni√≥n
                    </button>
                    <button class="btn btn-success" onclick="uploadFile()">
                        <i class="fas fa-cloud-upload-alt"></i> Subir Archivo
                    </button>
                    <button class="btn btn-secondary" onclick="showExportModal()">
                        <i class="fas fa-download"></i> Exportar Datos
                    </button>
                </div>
            </div>

            <!-- CALENDARIO -->
            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-calendar-alt"></i> Calendario</h2>
                </div>
                <div class="calendar">
                    <div class="calendar-nav">
                        <button class="btn btn-secondary" onclick="previousMonth()">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <h2 id="current-month">Enero 2024</h2>
                        <button class="btn btn-secondary" onclick="nextMonth()">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                    <div class="calendar-days" id="calendar-days">
                        <!-- D√≠as generados din√°micamente -->
                    </div>
                </div>
            </div>

            <!-- ESTAD√çSTICAS -->
            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-chart-bar"></i> Estad√≠sticas</h2>
                </div>
                <div style="padding: 20px 0;">
                    <div style="margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span>Tasa de Completado</span>
                            <span id="completion-rate">0%</span>
                        </div>
                        <div style="height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden;">
                            <div id="completion-bar" style="height: 100%; background: var(--color-success); width: 0%; transition: width 0.5s ease;"></div>
                        </div>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span>Productividad Semanal</span>
                            <span id="productivity-rate">0%</span>
                        </div>
                        <div style="height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden;">
                            <div id="productivity-bar" style="height: 100%; background: var(--color-info); width: 0%; transition: width 0.5s ease;"></div>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; font-weight: 700;" id="total-tasks">0</div>
                            <div style="font-size: 0.85rem; color: rgba(255,255,255,0.7);">Total Tareas</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; font-weight: 700;" id="active-tasks">0</div>
                            <div style="font-size: 0.85rem; color: rgba(255,255,255,0.7);">Tareas Activas</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- GESTI√ìN DE TAREAS -->
        <div class="card" style="margin-bottom: 30px;">
            <div class="card-header">
                <h2><i class="fas fa-tasks"></i> Gesti√≥n de Tareas</h2>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="task-search" class="form-control" style="width: 250px;" placeholder="üîç Buscar tareas..." onkeyup="searchTasks()">
                    <select id="task-filter" class="form-control" style="width: 150px;" onchange="filterTasks()">
                        <option value="all">Todas las tareas</option>
                        <option value="today">Hoy</option>
                        <option value="pending">Pendientes</option>
                        <option value="completed">Completadas</option>
                        <option value="urgent">Urgentes</option>
                    </select>
                </div>
            </div>

            <div class="task-filters">
                <button class="filter-btn active" onclick="setFilter('all')">Todas</button>
                <button class="filter-btn" onclick="setFilter('today')">Hoy</button>
                <button class="filter-btn" onclick="setFilter('pending')">Pendientes</button>
                <button class="filter-btn" onclick="setFilter('in-progress')">En Progreso</button>
                <button class="filter-btn" onclick="setFilter('completed')">Completadas</button>
                <button class="filter-btn" onclick="setFilter('urgent')">Urgentes</button>
            </div>

            <div class="tasks-container">
                <div id="task-list" class="task-list">
                    <!-- Tareas cargadas din√°micamente -->
                </div>
                <div id="empty-state" class="empty-state" style="display: none;">
                    <div class="empty-icon">
                        <i class="fas fa-clipboard-list"></i>
                    </div>
                    <h3>No hay tareas registradas</h3>
                    <p>Comienza agregando tu primera tarea profesional</p>
                    <button class="btn btn-primary" onclick="openTaskModal()" style="margin-top: 20px;">
                        <i class="fas fa-plus"></i> Crear Primera Tarea
                    </button>
                </div>
            </div>
        </div>

        <!-- SECCI√ìN MEJORADA DE SUBIDA DE ARCHIVOS -->
        <div class="card">
            <div class="card-header">
                <h2><i class="fas fa-cloud-upload-alt"></i> Gesti√≥n Profesional de Archivos</h2>
                <div class="action-buttons">
                    <button class="btn btn-success" onclick="openFileUpload()">
                        <i class="fas fa-cloud-upload-alt"></i> Subir Archivos
                    </button>
                    <button class="btn btn-email" onclick="agenda.exportToEmail()">
                        <i class="fas fa-envelope"></i> Enviar por Email
                    </button>
                    <button class="btn btn-print" onclick="agenda.printProfessionalReport()">
                        <i class="fas fa-print"></i> Imprimir Reporte
                    </button>
                    <button class="btn btn-secondary" onclick="agenda.downloadAllFiles()">
                        <i class="fas fa-download"></i> Descargar Todo
                    </button>
                </div>
            </div>
            
            <!-- √ÅREA DE SUBIDA MEJORADA -->
            <div class="file-upload-system" id="file-drop-area" 
                 onclick="document.getElementById('file-input').click()"
                 ondragover="handleDragOver(event)"
                 ondragleave="handleDragLeave(event)"
                 ondrop="handleFileDrop(event)">
                <i class="fas fa-cloud-upload-alt fa-3x" style="margin-bottom: 20px;"></i>
                <h3>Arrastra y suelta archivos aqu√≠</h3>
                <p>o haz clic para seleccionar</p>
                <p class="text-muted">Formatos: JPG, PNG, PDF, DOCX, XLSX, TXT, CSV (M√°x. 25MB)</p>
                <input type="file" id="file-input" multiple style="display: none;" 
                       accept=".jpg,.jpeg,.png,.pdf,.doc,.docx,.xls,.xlsx,.txt,.csv">
            </div>
            
            <!-- PREVISUALIZACI√ìN DE ARCHIVOS -->
            <div id="file-previews" class="file-preview-container">
                <!-- Archivos aparecen aqu√≠ din√°micamente -->
            </div>
            
            <!-- ESTAD√çSTICAS DE ARCHIVOS -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 30px;">
                <div class="stat-item">
                    <div class="stat-icon files">
                        <i class="fas fa-database"></i>
                    </div>
                    <div class="stat-info">
                        <div class="stat-label">Espacio Usado</div>
                        <div class="stat-value" id="storage-used">0 MB</div>
                    </div>
                </div>
                <div class="stat-item">
                    <div class="stat-icon completed">
                        <i class="fas fa-file-pdf"></i>
                    </div>
                    <div class="stat-info">
                        <div class="stat-label">Documentos PDF</div>
                        <div class="stat-value" id="pdf-count">0</div>
                    </div>
                </div>
                <div class="stat-item">
                    <div class="stat-icon meeting">
                        <i class="fas fa-file-image"></i>
                    </div>
                    <div class="stat-info">
                        <div class="stat-label">Im√°genes</div>
                        <div class="stat-value" id="image-count">0</div>
                    </div>
                </div>
                <div class="stat-item">
                    <div class="stat-icon pending">
                        <i class="fas fa-file-alt"></i>
                    </div>
                    <div class="stat-info">
                        <div class="stat-label">Otros Archivos</div>
                        <div class="stat-value" id="other-files-count">0</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- CABECERA PARA IMPRESI√ìN -->
    <div class="print-header print-only">
        <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIwIiBoZWlnaHQ9IjEyMCIgdmlld0JveD0iMCAwIDEyMCAxMjAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxwYXRoIGQ9Ik02MCAxMUMzNy45MSAxMSAyMCAyOC45MSAyMCA1MVMzNy45MSA5MSA2MCA5MSAxMDAgNzMuMDkgMTAwIDUxUzgyLjA5IDExIDYwIDExWk00OC41IDU1LjVMMzcuNSA0NC41TDI1IDU3TDQ4LjUgODAuNUw5NSAzNEw4Mi41IDIxLjVMNDguNSA1NS41WiIgZmlsbD0iIzAwQzZGNSIvPgo8L3N2Zz4K" alt="Logo DRTE" style="height: 60px;">
        <h1>Agenda Digital DRTE - Reporte Oficial</h1>
        <p>Departamento de Investigaci√≥n, Desarrollo e Implementaci√≥n</p>
        <p>Generado: <span id="print-date"></span></p>
    </div>
    
    <script>
        // ============================================
        // CLASE PRINCIPAL AGENDA DRTE (COMPLETA)
        // ============================================
        
        class AgendaDRTE {
            constructor() {
                this.version = '4.0.0';
                this.currentFilter = 'all';
                this.currentMonth = new Date().getMonth();
                this.currentYear = new Date().getFullYear();
                this.editingTaskId = null;
                
                // Inicializar sistema
                this.init();
            }

            async init() {
                // Iniciar reloj en tiempo real
                this.updateDateTime();
                setInterval(() => this.updateDateTime(), 1000);
                
                // Cargar datos del sistema
                await this.loadSystemData();
                
                // Inicializar calendario
                this.renderCalendar();
                
                // Mostrar estado listo
                this.showNotification('Sistema listo', 'Agenda DRTE cargada exitosamente', 'success');
            }

            // ============================================
            // GESTI√ìN DE TAREAS (CRUD COMPLETO)
            // ============================================

            async saveTask(event) {
                event.preventDefault();
                
                try {
                    const task = {
                        id: this.editingTaskId || Date.now().toString(),
                        title: document.getElementById('task-title').value.trim(),
                        description: document.getElementById('task-description').value.trim(),
                        date: document.getElementById('task-date').value,
                        priority: document.getElementById('task-priority').value,
                        category: document.getElementById('task-category').value,
                        status: document.getElementById('task-status').value,
                        tags: document.getElementById('task-tags').value.split(',').map(tag => tag.trim()).filter(tag => tag),
                        location: document.getElementById('task-location').value.trim(),
                        createdAt: this.editingTaskId ? this.getTask(this.editingTaskId)?.createdAt || new Date().toISOString() : new Date().toISOString(),
                        updatedAt: new Date().toISOString(),
                        completedAt: document.getElementById('task-status').value === 'completed' ? new Date().toISOString() : null
                    };

                    // Validar datos requeridos
                    if (!task.title || !task.date || !task.priority || !task.category) {
                        throw new Error('Por favor complete todos los campos requeridos');
                    }

                    // Guardar en localStorage
                    const tasks = this.getTasks();
                    const taskIndex = tasks.findIndex(t => t.id === task.id);
                    
                    if (taskIndex > -1) {
                        tasks[taskIndex] = task;
                    } else {
                        tasks.push(task);
                    }
                    
                    localStorage.setItem('agenda_tasks', JSON.stringify(tasks));
                    
                    // Cerrar modal y actualizar interfaz
                    this.closeModal('task-modal');
                    this.renderTasks();
                    this.updateStatistics();
                    this.renderCalendar();
                    
                    // Mostrar notificaci√≥n
                    this.showNotification(
                        'Tarea guardada',
                        `"${task.title}" ha sido ${this.editingTaskId ? 'actualizada' : 'creada'} exitosamente`,
                        'success'
                    );
                    
                    // Limpiar formulario
                    this.editingTaskId = null;
                    document.getElementById('task-form').reset();
                    document.getElementById('task-date').value = new Date().toISOString().split('T')[0];
                    
                } catch (error) {
                    this.showNotification('Error', error.message, 'error');
                }
            }

            getTasks() {
                try {
                    const tasks = localStorage.getItem('agenda_tasks');
                    return tasks ? JSON.parse(tasks) : [];
                } catch (error) {
                    console.error('Error al cargar tareas:', error);
                    return [];
                }
            }

            getTask(id) {
                const tasks = this.getTasks();
                return tasks.find(task => task.id === id);
            }

            deleteTask(id) {
                if (!confirm('¬øEst√° seguro de eliminar esta tarea?')) return;
                
                try {
                    const tasks = this.getTasks();
                    const filteredTasks = tasks.filter(task => task.id !== id);
                    localStorage.setItem('agenda_tasks', JSON.stringify(filteredTasks));
                    
                    this.renderTasks();
                    this.updateStatistics();
                    this.renderCalendar();
                    
                    this.showNotification('Tarea eliminada', 'La tarea ha sido eliminada exitosamente', 'success');
                } catch (error) {
                    this.showNotification('Error', 'No se pudo eliminar la tarea', 'error');
                }
            }

            editTask(id) {
                const task = this.getTask(id);
                if (!task) return;
                
                this.editingTaskId = id;
                
                // Llenar formulario con datos de la tarea
                document.getElementById('task-title').value = task.title;
                document.getElementById('task-description').value = task.description || '';
                document.getElementById('task-date').value = task.date;
                document.getElementById('task-priority').value = task.priority;
                document.getElementById('task-category').value = task.category;
                document.getElementById('task-status').value = task.status;
                document.getElementById('task-tags').value = task.tags?.join(', ') || '';
                document.getElementById('task-location').value = task.location || '';
                
                // Abrir modal
                this.openModal('task-modal');
            }

            toggleTaskStatus(id) {
                const tasks = this.getTasks();
                const taskIndex = tasks.findIndex(task => task.id === id);
                
                if (taskIndex > -1) {
                    tasks[taskIndex].status = tasks[taskIndex].status === 'completed' ? 'pending' : 'completed';
                    tasks[taskIndex].updatedAt = new Date().toISOString();
                    tasks[taskIndex].completedAt = tasks[taskIndex].status === 'completed' ? new Date().toISOString() : null;
                    
                    localStorage.setItem('agenda_tasks', JSON.stringify(tasks));
                    this.renderTasks();
                    this.updateStatistics();
                    
                    const statusText = tasks[taskIndex].status === 'completed' ? 'completada' : 'marcada como pendiente';
                    this.showNotification('Estado actualizado', `Tarea "${tasks[taskIndex].title}" ${statusText}`, 'success');
                }
            }

            // ============================================
            // RENDERIZADO DE INTERFAZ
            // ============================================

            renderTasks() {
                const tasks = this.getTasks();
                const taskList = document.getElementById('task-list');
                const emptyState = document.getElementById('empty-state');
                const searchTerm = document.getElementById('task-search').value.toLowerCase();
                
                // Aplicar filtros
                let filteredTasks = tasks;
                
                if (searchTerm) {
                    filteredTasks = filteredTasks.filter(task =>
                        task.title.toLowerCase().includes(searchTerm) ||
                        task.description.toLowerCase().includes(searchTerm) ||
                        (task.tags && task.tags.some(tag => tag.toLowerCase().includes(searchTerm)))
                    );
                }
                
                if (this.currentFilter !== 'all') {
                    filteredTasks = filteredTasks.filter(task => {
                        if (this.currentFilter === 'today') {
                            return task.date === new Date().toISOString().split('T')[0];
                        }
                        return task.status === this.currentFilter || task.priority === this.currentFilter;
                    });
                }
                
                // Ordenar tareas
                filteredTasks.sort((a, b) => {
                    const dateCompare = new Date(a.date) - new Date(b.date);
                    if (dateCompare !== 0) return dateCompare;
                    
                    const priorityOrder = { urgent: 0, high: 1, medium: 2, low: 3 };
                    return priorityOrder[a.priority] - priorityOrder[b.priority];
                });
                
                // Mostrar/ocultar estado vac√≠o
                if (filteredTasks.length === 0) {
                    taskList.style.display = 'none';
                    emptyState.style.display = 'block';
                } else {
                    taskList.style.display = 'flex';
                    emptyState.style.display = 'none';
                    
                    // Renderizar tareas
                    taskList.innerHTML = filteredTasks.map(task => `
                        <div class="task-item ${task.status} ${task.priority}" data-task-id="${task.id}">
                            <div class="task-header">
                                <div class="task-title">
                                    <i class="fas fa-${this.getTaskIcon(task.category)}"></i>
                                    ${task.title}
                                </div>
                                <div class="task-actions">
                                    <button class="task-action-btn" onclick="agenda.toggleTaskStatus('${task.id}')" title="${task.status === 'completed' ? 'Marcar como pendiente' : 'Marcar como completada'}">
                                        <i class="fas fa-${task.status === 'completed' ? 'undo' : 'check'}"></i>
                                    </button>
                                    <button class="task-action-btn" onclick="agenda.editTask('${task.id}')" title="Editar">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="task-action-btn" onclick="agenda.deleteTask('${task.id}')" title="Eliminar">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            ${task.description ? `<p style="margin: 10px 0; color: rgba(255,255,255,0.8);">${task.description}</p>` : ''}
                            <div class="task-meta">
                                <span class="task-meta-item">
                                    <i class="fas fa-calendar"></i> ${this.formatDate(task.date)}
                                </span>
                                <span class="task-meta-item">
                                    <i class="fas fa-tag"></i> ${this.getCategoryLabel(task.category)}
                                </span>
                                <span class="task-meta-item">
                                    ${this.getPriorityBadge(task.priority)}
                                </span>
                                ${task.location ? `<span class="task-meta-item"><i class="fas fa-map-marker-alt"></i> ${task.location}</span>` : ''}
                            </div>
                            ${task.tags && task.tags.length > 0 ? `
                                <div style="margin-top: 10px;">
                                    ${task.tags.map(tag => `<span style="background: rgba(255,255,255,0.1); padding: 4px 10px; border-radius: 12px; font-size: 0.8rem; margin-right: 5px;">${tag}</span>`).join('')}
                                </div>
                            ` : ''}
                        </div>
                    `).join('');
                }
            }

            // ============================================
            // CALENDARIO DIN√ÅMICO
            // ============================================

            renderCalendar() {
                const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
                const weekdays = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
                
                // Actualizar t√≠tulo del mes
                document.getElementById('current-month').textContent = `${monthNames[this.currentMonth]} ${this.currentYear}`;
                
                const firstDay = new Date(this.currentYear, this.currentMonth, 1);
                const lastDay = new Date(this.currentYear, this.currentMonth + 1, 0);
                const daysInMonth = lastDay.getDate();
                const startingDay = firstDay.getDay();
                
                // Obtener tareas para el mes actual
                const tasks = this.getTasks();
                const today = new Date().toISOString().split('T')[0];
                
                // Generar calendario
                const calendarDays = document.getElementById('calendar-days');
                calendarDays.innerHTML = '';
                
                // D√≠as de la semana
                weekdays.forEach(day => {
                    const dayElement = document.createElement('div');
                    dayElement.className = 'calendar-weekday';
                    dayElement.textContent = day;
                    calendarDays.appendChild(dayElement);
                });
                
                // D√≠as vac√≠os al inicio
                for (let i = 0; i < startingDay; i++) {
                    const emptyDay = document.createElement('div');
                    emptyDay.className = 'calendar-day';
                    calendarDays.appendChild(emptyDay);
                }
                
                // D√≠as del mes
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateStr = `${this.currentYear}-${String(this.currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const dayTasks = tasks.filter(task => task.date === dateStr);
                    const isToday = dateStr === today;
                    
                    const dayElement = document.createElement('div');
                    dayElement.className = 'calendar-day' + (isToday ? ' today' : '') + (dayTasks.length > 0 ? ' has-event' : '');
                    dayElement.textContent = day;
                    dayElement.dataset.date = dateStr;
                    
                    if (dayTasks.length > 0) {
                        dayElement.title = `${dayTasks.length} tarea(s) programada(s)`;
                        dayElement.style.cursor = 'pointer';
                        dayElement.onclick = () => this.showDayTasks(dateStr);
                    }
                    
                    calendarDays.appendChild(dayElement);
                }
            }

            previousMonth() {
                this.currentMonth--;
                if (this.currentMonth < 0) {
                    this.currentMonth = 11;
                    this.currentYear--;
                }
                this.renderCalendar();
            }

            nextMonth() {
                this.currentMonth++;
                if (this.currentMonth > 11) {
                    this.currentMonth = 0;
                    this.currentYear++;
                }
                this.renderCalendar();
            }

            // ============================================
            // ESTAD√çSTICAS Y AN√ÅLISIS
            // ============================================

            updateStatistics() {
                const tasks = this.getTasks();
                const today = new Date().toISOString().split('T')[0];
                
                // Estad√≠sticas del d√≠a
                const todayTasks = tasks.filter(task => task.date === today);
                const todayPending = todayTasks.filter(task => task.status !== 'completed').length;
                const todayCompleted = todayTasks.filter(task => task.status === 'completed').length;
                const todayMeetings = tasks.filter(task => task.date === today && task.category === 'meeting').length;
                
                document.getElementById('today-pending').textContent = todayPending;
                document.getElementById('today-completed').textContent = todayCompleted;
                document.getElementById('today-meetings').textContent = todayMeetings;
                
                // Estad√≠sticas generales
                const totalTasks = tasks.length;
                const completedTasks = tasks.filter(task => task.status === 'completed').length;
                const activeTasks = tasks.filter(task => task.status !== 'completed').length;
                const completionRate = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
                const productivityRate = Math.min(100, Math.round((completedTasks / Math.max(1, activeTasks + completedTasks)) * 100));
                
                document.getElementById('total-tasks').textContent = totalTasks;
                document.getElementById('active-tasks').textContent = activeTasks;
                document.getElementById('completion-rate').textContent = `${completionRate}%`;
                document.getElementById('productivity-rate').textContent = `${productivityRate}%`;
                
                // Actualizar barras de progreso
                document.getElementById('completion-bar').style.width = `${completionRate}%`;
                document.getElementById('productivity-bar').style.width = `${productivityRate}%`;
                
                // Actualizar badge del d√≠a
                document.getElementById('today-badge').textContent = `HOY (${todayTasks.length})`;
            }

            // ============================================
            // EXPORTACI√ìN PROFESIONAL
            // ============================================

            exportToExcel() {
                try {
                    const tasks = this.getTasks();
                    
                    // Crear hoja de trabajo
                    const wsData = [
                        ['AGENDA DIGITAL DRTE - REPORTE PROFESIONAL'],
                        ['Generado: ' + this.formatDateTime(new Date())],
                        [''],
                        ['ID', 'T√≠tulo', 'Descripci√≥n', 'Fecha', 'Categor√≠a', 'Prioridad', 'Estado', 'Etiquetas', 'Ubicaci√≥n', 'Creado', 'Actualizado', 'Completado']
                    ];
                    
                    tasks.forEach(task => {
                        wsData.push([
                            task.id,
                            task.title,
                            task.description || '',
                            task.date,
                            this.getCategoryLabel(task.category),
                            this.getPriorityLabel(task.priority),
                            this.getStatusLabel(task.status),
                            task.tags?.join('; ') || '',
                            task.location || '',
                            this.formatDateTime(new Date(task.createdAt)),
                            this.formatDateTime(new Date(task.updatedAt)),
                            task.completedAt ? this.formatDateTime(new Date(task.completedAt)) : ''
                        ]);
                    });
                    
                    const ws = XLSX.utils.aoa_to_sheet(wsData);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, 'Tareas DRTE');
                    
                    // Generar archivo
                    const fileName = `Agenda_DRTE_${this.formatDate(new Date()).replace(/\//g, '-')}.xlsx`;
                    XLSX.writeFile(wb, fileName);
                    
                    this.showNotification('Exportaci√≥n exitosa', 'Reporte Excel generado correctamente', 'success');
                    this.closeModal('export-modal');
                    
                } catch (error) {
                    console.error('Error en exportaci√≥n Excel:', error);
                    this.showNotification('Error', 'No se pudo generar el reporte Excel', 'error');
                }
            }

            exportToPDF() {
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF('p', 'mm', 'a4');
                    
                    // T√≠tulo
                    doc.setFontSize(20);
                    doc.setFont('helvetica', 'bold');
                    doc.text('AGENDA DIGITAL DRTE - REPORTE PROFESIONAL', 105, 20, { align: 'center' });
                    
                    // Informaci√≥n del reporte
                    doc.setFontSize(11);
                    doc.setFont('helvetica', 'normal');
                    doc.text(`Generado: ${this.formatDateTime(new Date())}`, 105, 30, { align: 'center' });
                    
                    // Estad√≠sticas
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.text('RESUMEN ESTAD√çSTICO', 20, 45);
                    
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'normal');
                    const tasks = this.getTasks();
                    const completed = tasks.filter(t => t.status === 'completed').length;
                    
                    doc.text(`Total de tareas: ${tasks.length}`, 20, 55);
                    doc.text(`Completadas: ${completed}`, 20, 62);
                    doc.text(`Tasa de completado: ${Math.round((completed / Math.max(1, tasks.length)) * 100)}%`, 20, 69);
                    
                    // Tareas
                    let yPos = 85;
                    tasks.forEach((task, index) => {
                        if (yPos > 270) {
                            doc.addPage();
                            yPos = 20;
                        }
                        
                        doc.setFont('helvetica', 'bold');
                        doc.text(`${index + 1}. ${task.title}`, 20, yPos);
                        yPos += 7;
                        
                        doc.setFont('helvetica', 'normal');
                        doc.text(`Fecha: ${task.date} | Categor√≠a: ${this.getCategoryLabel(task.category)} | Prioridad: ${this.getPriorityLabel(task.priority)}`, 25, yPos);
                        yPos += 5;
                        
                        if (task.description) {
                            const lines = doc.splitTextToSize(task.description, 160);
                            doc.text(lines, 25, yPos);
                            yPos += lines.length * 5;
                        }
                        
                        yPos += 10;
                    });
                    
                    // Guardar PDF
                    const fileName = `Reporte_DRTE_${this.formatDate(new Date()).replace(/\//g, '-')}.pdf`;
                    doc.save(fileName);
                    
                    this.showNotification('Exportaci√≥n exitosa', 'Reporte PDF generado correctamente', 'success');
                    this.closeModal('export-modal');
                    
                } catch (error) {
                    console.error('Error en exportaci√≥n PDF:', error);
                    this.showNotification('Error', 'No se pudo generar el reporte PDF', 'error');
                }
            }

            exportToCSV() {
                try {
                    const tasks = this.getTasks();
                    let csvContent = 'data:text/csv;charset=utf-8,';
                    
                    // Encabezados
                    csvContent += 'ID,T√≠tulo,Descripci√≥n,Fecha,Categor√≠a,Prioridad,Estado,Etiquetas,Ubicaci√≥n,Creado,Actualizado,Completado\n';
                    
                    // Datos
                    tasks.forEach(task => {
                        csvContent += [
                            task.id,
                            `"${task.title.replace(/"/g, '""')}"`,
                            `"${(task.description || '').replace(/"/g, '""')}"`,
                            task.date,
                            this.getCategoryLabel(task.category),
                            this.getPriorityLabel(task.priority),
                            this.getStatusLabel(task.status),
                            `"${(task.tags?.join('; ') || '').replace(/"/g, '""')}"`,
                            `"${(task.location || '').replace(/"/g, '""')}"`,
                            this.formatDateTime(new Date(task.createdAt)),
                            this.formatDateTime(new Date(task.updatedAt)),
                            task.completedAt ? this.formatDateTime(new Date(task.completedAt)) : ''
                        ].join(',') + '\n';
                    });
                    
                    // Descargar
                    const encodedUri = encodeURI(csvContent);
                    const link = document.createElement('a');
                    link.setAttribute('href', encodedUri);
                    link.setAttribute('download', `Tareas_DRTE_${this.formatDate(new Date()).replace(/\//g, '-')}.csv`);
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    this.showNotification('Exportaci√≥n exitosa', 'Archivo CSV generado correctamente', 'success');
                    this.closeModal('export-modal');
                    
                } catch (error) {
                    console.error('Error en exportaci√≥n CSV:', error);
                    this.showNotification('Error', 'No se pudo generar el archivo CSV', 'error');
                }
            }

            exportBackup() {
                try {
                    const backupData = {
                        timestamp: new Date().toISOString(),
                        version: this.version,
                        tasks: this.getTasks(),
                        settings: {
                            lastBackup: new Date().toISOString(),
                            totalTasks: this.getTasks().length
                        }
                    };
                    
                    const dataStr = JSON.stringify(backupData, null, 2);
                    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                    
                    const link = document.createElement('a');
                    link.setAttribute('href', dataUri);
                    link.setAttribute('download', `backup_drte_${this.formatDate(new Date()).replace(/\//g, '-')}.json`);
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    this.showNotification('Backup creado', 'Copia de seguridad exportada exitosamente', 'success');
                    
                } catch (error) {
                    console.error('Error en backup:', error);
                    this.showNotification('Error', 'No se pudo crear el backup', 'error');
                }
            }

            // ============================================
            // UTILIDADES
            // ============================================

            formatDate(dateStr) {
                const date = new Date(dateStr);
                return date.toLocaleDateString('es-CR', {
                    weekday: 'short',
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            }

            formatDateTime(date) {
                return date.toLocaleString('es-CR', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
            }

            updateDateTime() {
                const now = new Date();
                const options = {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    timeZone: 'America/Costa_Rica'
                };
                
                document.getElementById('current-datetime').innerHTML = 
                    `<i class="fas fa-clock"></i> ${now.toLocaleDateString('es-CR', options)} UTC-6 üá®üá∑`;
            }

            getTaskIcon(category) {
                const icons = {
                    'pntf': 'chart-line',
                    'meeting': 'users',
                    'training': 'graduation-cap',
                    'design': 'paint-brush',
                    'report': 'file-alt',
                    'system': 'laptop-code',
                    'other': 'tasks'
                };
                return icons[category] || 'tasks';
            }

            getCategoryLabel(category) {
                const labels = {
                    'pntf': 'PNFT',
                    'meeting': 'Reuni√≥n',
                    'training': 'Capacitaci√≥n',
                    'design': 'Dise√±o',
                    'report': 'Informe',
                    'system': 'Sistema',
                    'other': 'Otra'
                };
                return labels[category] || category;
            }

            getPriorityLabel(priority) {
                const labels = {
                    'low': 'Baja',
                    'medium': 'Media',
                    'high': 'Alta',
                    'urgent': 'Urgente'
                };
                return labels[priority] || priority;
            }

            getPriorityBadge(priority) {
                const badges = {
                    'low': 'üü¢ Baja',
                    'medium': 'üü° Media',
                    'high': 'üü† Alta',
                    'urgent': 'üî¥ Urgente'
                };
                return badges[priority] || priority;
            }

            getStatusLabel(status) {
                const labels = {
                    'pending': 'Pendiente',
                    'in-progress': 'En Progreso',
                    'completed': 'Completado'
                };
                return labels[status] || status;
            }

            // ============================================
            // INTERFAZ Y MODALES
            // ============================================

            openModal(modalId) {
                document.getElementById(modalId).classList.add('active');
                document.body.style.overflow = 'hidden';
            }

            closeModal(modalId) {
                document.getElementById(modalId).classList.remove('active');
                document.body.style.overflow = 'auto';
                
                // Limpiar formulario
                if (modalId === 'task-modal') {
                    document.getElementById('task-form').reset();
                    document.getElementById('task-date').value = new Date().toISOString().split('T')[0];
                    this.editingTaskId = null;
                }
            }

            showExportModal() {
                this.openModal('export-modal');
            }

            openTaskModal() {
                document.getElementById('task-date').value = new Date().toISOString().split('T')[0];
                this.openModal('task-modal');
            }

            showNotification(title, message, type = 'info') {
                const notificationCenter = document.getElementById('notification-center');
                
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.innerHTML = `
                    <div>
                        <strong>${title}</strong>
                        <p style="margin: 5px 0 0; font-size: 0.9rem; opacity: 0.9;">${message}</p>
                    </div>
                    <button class="task-action-btn" onclick="this.parentElement.remove()">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                notificationCenter.appendChild(notification);
                
                // Auto-eliminar despu√©s de 5 segundos
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.style.opacity = '0';
                        notification.style.transform = 'translateX(100%)';
                        setTimeout(() => notification.remove(), 300);
                    }
                }, 5000);
            }

            // ============================================
            // FILTROS Y B√öSQUEDA
            // ============================================

            setFilter(filter) {
                this.currentFilter = filter;
                
                // Actualizar botones de filtro
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                event.target.classList.add('active');
                
                this.renderTasks();
            }

            searchTasks() {
                this.renderTasks();
            }

            filterTasks() {
                const filter = document.getElementById('task-filter').value;
                this.currentFilter = filter;
                this.renderTasks();
            }

            // ============================================
            // CARGA DEL SISTEMA
            // ============================================

            async loadSystemData() {
                try {
                    // Cargar tareas
                    this.renderTasks();
                    this.updateStatistics();
                    
                    // Configurar fecha de hoy por defecto
                    document.getElementById('task-date').value = new Date().toISOString().split('T')[0];
                    
                    // Mostrar estado del sistema
                    console.log('Sistema Agenda DRTE cargado exitosamente');
                    
                } catch (error) {
                    console.error('Error al cargar datos del sistema:', error);
                    this.showNotification('Error', 'Error al cargar datos del sistema', 'error');
                }
            }

            // ============================================
            // FUNCIONES R√ÅPIDAS
            // ============================================

            quickMeeting() {
                document.getElementById('task-title').value = 'Reuni√≥n de coordinaci√≥n';
                document.getElementById('task-category').value = 'meeting';
                document.getElementById('task-priority').value = 'medium';
                this.openModal('task-modal');
            }

            uploadFile() {
                const input = document.createElement('input');
                input.type = 'file';
                input.multiple = true;
                input.accept = '.jpg,.jpeg,.png,.pdf,.doc,.docx,.xls,.xlsx,.txt,.csv';
                
                input.onchange = (e) => {
                    const files = Array.from(e.target.files);
                    if (files.length > 0) {
                        this.showNotification('Archivos subidos', `${files.length} archivo(s) listo(s) para procesar`, 'success');
                        // Aqu√≠ podr√≠as implementar la subida real a IndexedDB
                    }
                };
                
                input.click();
            }

            openBackupManager() {
                this.showNotification('Gestor de Backups', 'Funcionalidad en desarrollo', 'info');
            }

            showDayTasks(date) {
                const tasks = this.getTasks().filter(task => task.date === date);
                if (tasks.length === 0) return;
                
                const taskList = tasks.map(task => `‚Ä¢ ${task.title} (${this.getPriorityLabel(task.priority)})`).join('\n');
                alert(`Tareas para ${date}:\n\n${taskList}`);
            }
        }

        // ============================================
        // SISTEMA COMPLETO DE ARCHIVOS CON INDEXEDDB
        // ============================================
        
        class FileSystemManager {
            constructor() {
                this.db = null;
                this.currentFile = null;
                this.initDatabase();
            }
            
            async initDatabase() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open('AgendaDRTE_Files', 1);
                    
                    request.onerror = () => reject('Error al abrir IndexedDB');
                    request.onsuccess = (event) => {
                        this.db = event.target.result;
                        console.log('‚úÖ IndexedDB para archivos inicializada');
                        this.updateFileStats();
                        resolve();
                    };
                    
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains('files')) {
                            const store = db.createObjectStore('files', { keyPath: 'id' });
                            store.createIndex('type', 'type', { unique: false });
                            store.createIndex('date', 'uploadDate', { unique: false });
                        }
                    };
                });
            }
            
            async uploadFiles(fileList) {
                try {
                    const uploadedFiles = [];
                    
                    for (const file of fileList) {
                        if (file.size > 25 * 1024 * 1024) {
                            throw new Error(`El archivo ${file.name} excede 25MB`);
                        }
                        
                        const fileData = {
                            id: Date.now() + '-' + Math.random().toString(36).substr(2, 9),
                            name: file.name,
                            type: file.type,
                            size: file.size,
                            uploadDate: new Date().toISOString(),
                            data: await this.readFileAsArrayBuffer(file)
                        };
                        
                        await this.saveFileToDB(fileData);
                        uploadedFiles.push(fileData);
                        
                        // Mostrar previsualizaci√≥n inmediata
                        this.addFilePreview(fileData);
                    }
                    
                    this.updateFileStats();
                    agenda.showNotification(
                        'Archivos subidos',
                        `${uploadedFiles.length} archivo(s) subido(s) exitosamente`,
                        'success'
                    );
                    
                    return uploadedFiles;
                    
                } catch (error) {
                    agenda.showNotification('Error', error.message, 'error');
                    throw error;
                }
            }
            
            readFileAsArrayBuffer(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = (e) => reject(e);
                    reader.readAsArrayBuffer(file);
                });
            }
            
            async saveFileToDB(fileData) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['files'], 'readwrite');
                    const store = transaction.objectStore('files');
                    const request = store.put(fileData);
                    
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject('Error al guardar archivo');
                });
            }
            
            addFilePreview(fileData) {
                const container = document.getElementById('file-previews');
                const preview = document.createElement('div');
                preview.className = 'file-preview';
                preview.dataset.fileId = fileData.id;
                
                let previewContent = '';
                
                if (fileData.type.startsWith('image/')) {
                    const blob = new Blob([fileData.data], { type: fileData.type });
                    const url = URL.createObjectURL(blob);
                    previewContent = `<img src="${url}" alt="${fileData.name}" onclick="fileSystem.previewFile('${fileData.id}')">`;
                } else if (fileData.type === 'application/pdf') {
                    previewContent = `
                        <i class="fas fa-file-pdf fa-3x" style="color: #ea4335;"></i>
                        <div style="text-align: center;">
                            <strong>${fileData.name}</strong>
                            <p style="font-size: 0.8rem; opacity: 0.8;">PDF - ${this.formatFileSize(fileData.size)}</p>
                        </div>
                    `;
                } else if (fileData.type.includes('word') || fileData.name.endsWith('.docx') || fileData.name.endsWith('.doc')) {
                    previewContent = `
                        <i class="fas fa-file-word fa-3x" style="color: #2b579a;"></i>
                        <div style="text-align: center;">
                            <strong>${fileData.name}</strong>
                            <p style="font-size: 0.8rem; opacity: 0.8;">Documento - ${this.formatFileSize(fileData.size)}</p>
                        </div>
                    `;
                } else if (fileData.type.includes('excel') || fileData.name.endsWith('.xlsx') || fileData.name.endsWith('.xls')) {
                    previewContent = `
                        <i class="fas fa-file-excel fa-3x" style="color: #217346;"></i>
                        <div style="text-align: center;">
                            <strong>${fileData.name}</strong>
                            <p style="font-size: 0.8rem; opacity: 0.8;">Excel - ${this.formatFileSize(fileData.size)}</p>
                        </div>
                    `;
                } else {
                    previewContent = `
                        <i class="fas fa-file fa-3x"></i>
                        <div style="text-align: center;">
                            <strong>${fileData.name}</strong>
                            <p style="font-size: 0.8rem; opacity: 0.8;">${fileData.type} - ${this.formatFileSize(fileData.size)}</p>
                        </div>
                    `;
                }
                
                preview.innerHTML = previewContent + `
                    <div class="file-actions">
                        <button class="btn btn-sm btn-primary" onclick="fileSystem.previewFile('${fileData.id}')">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-success" onclick="fileSystem.downloadFile('${fileData.id}')">
                            <i class="fas fa-download"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="fileSystem.deleteFile('${fileData.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                
                container.appendChild(preview);
            }
            
            async previewFile(fileId) {
                try {
                    const fileData = await this.getFileFromDB(fileId);
                    if (!fileData) {
                        throw new Error('Archivo no encontrado');
                    }
                    
                    this.currentFile = fileData;
                    const modal = document.getElementById('file-viewer-modal');
                    const title = document.getElementById('viewer-title');
                    const pdfViewer = document.getElementById('pdf-viewer');
                    const imageViewer = document.getElementById('image-viewer');
                    const textViewer = document.getElementById('text-viewer');
                    const otherViewer = document.getElementById('other-file-viewer');
                    
                    // Ocultar todos los visores
                    [pdfViewer, imageViewer, textViewer, otherViewer].forEach(v => v.style.display = 'none');
                    
                    // Configurar t√≠tulo
                    title.textContent = `Vista previa: ${fileData.name}`;
                    
                    // Crear blob para visualizaci√≥n
                    const blob = new Blob([fileData.data], { type: fileData.type });
                    const url = URL.createObjectURL(blob);
                    
                    // Mostrar seg√∫n tipo de archivo
                    if (fileData.type.startsWith('image/')) {
                        imageViewer.src = url;
                        imageViewer.style.display = 'block';
                        imageViewer.alt = fileData.name;
                    } else if (fileData.type === 'application/pdf') {
                        pdfViewer.src = url + '#view=FitH';
                        pdfViewer.style.display = 'block';
                    } else if (fileData.type.startsWith('text/')) {
                        const text = await blob.text();
                        textViewer.textContent = text;
                        textViewer.style.display = 'block';
                    } else {
                        otherViewer.style.display = 'block';
                    }
                    
                    modal.classList.add('active');
                    document.body.style.overflow = 'hidden';
                    
                } catch (error) {
                    agenda.showNotification('Error', 'No se pudo previsualizar el archivo', 'error');
                }
            }
            
            async downloadFile(fileId) {
                try {
                    const fileData = await this.getFileFromDB(fileId);
                    if (!fileData) {
                        throw new Error('Archivo no encontrado');
                    }
                    
                    const blob = new Blob([fileData.data], { type: fileData.type });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = fileData.name;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    agenda.showNotification('Descarga iniciada', `Descargando ${fileData.name}`, 'success');
                    
                } catch (error) {
                    agenda.showNotification('Error', 'No se pudo descargar el archivo', 'error');
                }
            }
            
            async deleteFile(fileId) {
                if (!confirm('¬øEst√° seguro de eliminar este archivo?')) return;
                
                try {
                    const transaction = this.db.transaction(['files'], 'readwrite');
                    const store = transaction.objectStore('files');
                    await store.delete(fileId);
                    
                    // Eliminar previsualizaci√≥n
                    const preview = document.querySelector(`[data-file-id="${fileId}"]`);
                    if (preview) preview.remove();
                    
                    this.updateFileStats();
                    agenda.showNotification('Archivo eliminado', 'El archivo ha sido eliminado', 'success');
                    
                } catch (error) {
                    agenda.showNotification('Error', 'No se pudo eliminar el archivo', 'error');
                }
            }
            
            async downloadAllFiles() {
                try {
                    const files = await this.getAllFiles();
                    if (files.length === 0) {
                        agenda.showNotification('Info', 'No hay archivos para descargar', 'info');
                        return;
                    }
                    
                    // Crear archivo ZIP (simplificado - en producci√≥n usar JSZip)
                    if (files.length === 1) {
                        this.downloadFile(files[0].id);
                    } else {
                        agenda.showNotification('Descarga m√∫ltiple', 
                            `Iniciando descarga de ${files.length} archivos`, 'info');
                        
                        // Descargar archivos uno por uno
                        for (const file of files) {
                            await this.downloadFile(file.id);
                            await new Promise(resolve => setTimeout(resolve, 500)); // Pausa entre descargas
                        }
                    }
                    
                } catch (error) {
                    agenda.showNotification('Error', 'Error en descarga m√∫ltiple', 'error');
                }
            }
            
            async getFileFromDB(fileId) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['files'], 'readonly');
                    const store = transaction.objectStore('files');
                    const request = store.get(fileId);
                    
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject('Error al obtener archivo');
                });
            }
            
            async getAllFiles() {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['files'], 'readonly');
                    const store = transaction.objectStore('files');
                    const request = store.getAll();
                    
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject('Error al obtener archivos');
                });
            }
            
            async updateFileStats() {
                try {
                    const files = await this.getAllFiles();
                    
                    // Calcular estad√≠sticas
                    const totalSize = files.reduce((sum, file) => sum + file.size, 0);
                    const pdfCount = files.filter(f => f.type === 'application/pdf').length;
                    const imageCount = files.filter(f => f.type.startsWith('image/')).length;
                    const otherCount = files.length - pdfCount - imageCount;
                    
                    // Actualizar UI
                    document.getElementById('total-files').textContent = files.length;
                    document.getElementById('storage-used').textContent = this.formatFileSize(totalSize);
                    document.getElementById('pdf-count').textContent = pdfCount;
                    document.getElementById('image-count').textContent = imageCount;
                    document.getElementById('other-files-count').textContent = otherCount;
                    
                } catch (error) {
                    console.error('Error actualizando estad√≠sticas:', error);
                }
            }
            
            formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }
        }

        // ============================================
        // CLASE MEJORADA CON TODAS LAS FUNCIONALIDADES
        // ============================================
        
        class EnhancedAgendaDRTE extends AgendaDRTE {
            constructor() {
                super();
                this.fileSystem = new FileSystemManager();
                this.initEnhancedFeatures();
            }
            
            initEnhancedFeatures() {
                // Inicializar arrastrar y soltar
                this.setupDragAndDrop();
                
                // Configurar fecha de impresi√≥n
                document.getElementById('print-date').textContent = 
                    new Date().toLocaleDateString('es-CR', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
            }
            
            setupDragAndDrop() {
                const dropArea = document.getElementById('file-drop-area');
                
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    dropArea.addEventListener(eventName, this.preventDefaults, false);
                });
                
                function handleDragOver(e) {
                    dropArea.classList.add('dragover');
                }
                
                function handleDragLeave(e) {
                    if (!dropArea.contains(e.relatedTarget)) {
                        dropArea.classList.remove('dragover');
                    }
                }
                
                async function handleFileDrop(e) {
                    dropArea.classList.remove('dragover');
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        await this.fileSystem.uploadFiles(files);
                    }
                }
                
                dropArea.addEventListener('dragover', handleDragOver);
                dropArea.addEventListener('dragleave', handleDragLeave);
                dropArea.addEventListener('drop', handleFileDrop.bind(this));
            }
            
            preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            // ============================================
            // SISTEMA DE IMPRESI√ìN PROFESIONAL
            // ============================================
            
            printProfessionalReport() {
                try {
                    // Guardar contenido actual
                    const originalTitle = document.title;
                    
                    // Configurar para impresi√≥n
                    document.title = 'Agenda DRTE - Reporte Oficial';
                    
                    // Mostrar solo elementos relevantes para imprimir
                    const elementsToPrint = document.querySelectorAll('.card, .print-header');
                    
                    // Ocultar elementos no deseados
                    document.querySelectorAll('.no-print, .external-links-panel, .btn').forEach(el => {
                        el.style.display = 'none';
                    });
                    
                    // Mostrar cabecera de impresi√≥n
                    document.querySelector('.print-header').style.display = 'block';
                    
                    // Imprimir
                    window.print();
                    
                    // Restaurar estado original
                    setTimeout(() => {
                        document.title = originalTitle;
                        document.querySelectorAll('.no-print, .external-links-panel, .btn').forEach(el => {
                            el.style.display = '';
                        });
                        document.querySelector('.print-header').style.display = 'none';
                    }, 1000);
                    
                    this.showNotification('Impresi√≥n', 'Reporte listo para imprimir', 'success');
                    
                } catch (error) {
                    console.error('Error en impresi√≥n:', error);
                    this.showNotification('Error', 'No se pudo preparar la impresi√≥n', 'error');
                }
            }
            
            // ============================================
            // SISTEMA DE CORREO ELECTR√ìNICO PROFESIONAL
            // ============================================
            
            exportToEmail() {
                try {
                    const tasks = this.getTasks();
                    const files = this.fileSystem.getAllFiles ? this.fileSystem.getAllFiles() : [];
                    
                    // Crear contenido del email
                    const subject = encodeURIComponent(`Reporte Agenda DRTE - ${this.formatDate(new Date())}`);
                    
                    let body = `Reporte generado desde Agenda Digital DRTE\n\n`;
                    body += `Fecha: ${new Date().toLocaleDateString('es-CR')}\n`;
                    body += `Total de tareas: ${tasks.length}\n`;
                    body += `Tareas completadas: ${tasks.filter(t => t.status === 'completed').length}\n\n`;
                    
                    body += `RESUMEN DE TAREAS:\n`;
                    body += `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n`;
                    
                    tasks.forEach((task, index) => {
                        body += `${index + 1}. ${task.title}\n`;
                        body += `   üìÖ ${task.date} | üìç ${this.getCategoryLabel(task.category)} | ${this.getPriorityBadge(task.priority)}\n`;
                        if (task.description) {
                            body += `   üìù ${task.description.substring(0, 100)}${task.description.length > 100 ? '...' : ''}\n`;
                        }
                        body += `\n`;
                    });
                    
                    body += `\nARCHIVOS ADJUNTOS (${files.length}):\n`;
                    body += `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n`;
                    
                    files.forEach(file => {
                        body += `‚Ä¢ ${file.name} (${this.fileSystem.formatFileSize(file.size)})\n`;
                    });
                    
                    body += `\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n`;
                    body += `Generado autom√°ticamente por Agenda Digital DRTE\n`;
                    body += `Departamento de Investigaci√≥n, Desarrollo e Implementaci√≥n`;
                    
                    // Crear enlace mailto
                    const mailtoLink = `mailto:?subject=${subject}&body=${encodeURIComponent(body)}`;
                    
                    // Abrir cliente de correo
                    window.open(mailtoLink, '_blank');
                    
                    this.showNotification('Correo listo', 'Cliente de correo abierto con el reporte', 'success');
                    
                } catch (error) {
                    console.error('Error en exportaci√≥n a email:', error);
                    this.showNotification('Error', 'No se pudo preparar el correo', 'error');
                }
            }
            
            // ============================================
            // FUNCIONES P√öBLICAS MEJORADAS
            // ============================================
            
            openFileUpload() {
                document.getElementById('file-input').click();
            }
            
            async handleFileSelect(event) {
                const files = event.target.files;
                if (files.length > 0) {
                    await this.fileSystem.uploadFiles(files);
                    event.target.value = ''; // Reset input
                }
            }
        }

        // ============================================
        // INICIALIZACI√ìN GLOBAL MEJORADA
        // ============================================
        
        let agenda;
        let fileSystem;
        
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Crear instancia mejorada
                agenda = new EnhancedAgendaDRTE();
                fileSystem = agenda.fileSystem;
                
                // Configurar eventos de archivos
                document.getElementById('file-input').addEventListener('change', (e) => {
                    agenda.handleFileSelect(e);
                });
                
                // Hacer globales
                window.agenda = agenda;
                window.fileSystem = fileSystem;
                
                // Configurar funciones globales
                window.handleDragOver = function(e) {
                    e.preventDefault();
                    document.getElementById('file-drop-area').classList.add('dragover');
                };
                
                window.handleDragLeave = function(e) {
                    e.preventDefault();
                    if (!document.getElementById('file-drop-area').contains(e.relatedTarget)) {
                        document.getElementById('file-drop-area').classList.remove('dragover');
                    }
                };
                
                window.handleFileDrop = async function(e) {
                    e.preventDefault();
                    document.getElementById('file-drop-area').classList.remove('dragover');
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        await fileSystem.uploadFiles(files);
                    }
                };
                
                window.closeViewer = function() {
                    document.getElementById('file-viewer-modal').classList.remove('active');
                    document.body.style.overflow = 'auto';
                    
                    // Liberar URLs de objetos
                    const viewers = ['pdf-viewer', 'image-viewer'];
                    viewers.forEach(id => {
                        const element = document.getElementById(id);
                        if (element.src) {
                            URL.revokeObjectURL(element.src);
                            element.src = '';
                        }
                    });
                };
                
                window.downloadCurrentFile = function() {
                    if (fileSystem.currentFile) {
                        fileSystem.downloadFile(fileSystem.currentFile.id);
                    }
                };
                
                console.log('üöÄ Sistema Agenda DRTE MEJORADO inicializado');
                
            } catch (error) {
                console.error('‚ùå Error cr√≠tico:', error);
                alert('Error al cargar la aplicaci√≥n. Por favor, recarga la p√°gina.');
            }
        });
        
        // Funciones globales mejoradas
        function openTaskModal() { agenda.openTaskModal(); }
        function closeModal(id) { agenda.closeModal(id); }
        function showExportModal() { agenda.showExportModal(); }
        function exportToExcel() { agenda.exportToExcel(); }
        function exportToPDF() { agenda.exportToPDF(); }
        function exportToCSV() { agenda.exportToCSV(); }
        function exportBackup() { agenda.exportBackup(); }
        function previousMonth() { agenda.previousMonth(); }
        function nextMonth() { agenda.nextMonth(); }
        function setFilter(filter) { agenda.setFilter(filter); }
        function searchTasks() { agenda.searchTasks(); }
        function filterTasks() { agenda.filterTasks(); }
        function saveTask(event) { agenda.saveTask(event); }
        function quickMeeting() { agenda.quickMeeting(); }
        function uploadFile() { agenda.uploadFile(); }
        function openBackupManager() { agenda.openBackupManager(); }
        function openFileUpload() { agenda.openFileUpload(); }
        function closeViewer() { 
            document.getElementById('file-viewer-modal').classList.remove('active');
            document.body.style.overflow = 'auto';
        }
    </script>
</body>
</html>
